#!/bin/bash

# --- FONKSÄ°YON: KullanÄ±cÄ±nÄ±n OpenVPN sertifikasÄ±nÄ± iptal eder ---
remove_ovp () {
    # EÄŸer sistem Debian/Ubuntu ise, grup adÄ±nÄ± 'nogroup' olarak ayarla.
    if [[ -e /etc/debian_version ]]; then
        GROUPNAME=nogroup
    fi
    user="$1"
    cd /etc/openvpn/easy-rsa/
    # EasyRSA kullanarak kullanÄ±cÄ±nÄ±n sertifikasÄ±nÄ± iptal et.
    ./easyrsa --batch revoke $user
    # Sertifika Ä°ptal Listesini (CRL) yeniden oluÅŸtur.
    ./easyrsa gen-crl
    # Eski sertifika dosyalarÄ±nÄ± temizle ve gÃ¼ncel CRL dosyasÄ±nÄ± kopyala.
    rm -rf pki/reqs/$user.req
    rm -rf pki/private/$user.key
    rm -rf pki/issued/$user.crt
    rm -rf /etc/openvpn/crl.pem
    cp /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/crl.pem
    chown nobody:$GROUPNAME /etc/openvpn/crl.pem
    # KullanÄ±cÄ±ya ait .ovpn ve .zip dosyalarÄ±nÄ± sil.
    [[ -e $HOME/$user.ovpn ]] && rm $HOME/$user.ovpn > /dev/null 2>&1
    [[ -e /var/www/html/openvpn/$user.zip ]] && rm /var/www/html/openvpn/$user.zip > /dev/null 2>&1
} > /dev/null 2>&1 # Bu fonksiyonun tÃ¼m Ã§Ä±ktÄ±sÄ±nÄ± gizle.

database="/root/usuarios.db"
clear
# BaÅŸlÄ±k metnini mavi arka plan Ã¼zerine beyaz ve kalÄ±n olarak yazdÄ±r.
tput setaf 7 ; tput setab 4 ; tput bold ; printf '%32s%s%-13s\n' "ã…¤ğŸ‰ã…¤ğŸš®ã…¤SSH KullanÄ±cÄ±sÄ± Silmeã…¤ğŸš®ã…¤ğŸ‰ã…¤" ; tput sgr0
echo ""
# Ana menÃ¼ seÃ§eneklerini gÃ¶ster.
echo -e "\033[1;31m[\033[1;36m1\033[1;31m]\033[1;33m BÄ°R KULLANICIYI SÄ°L"
echo -e "\033[1;31m[\033[1;36m2\033[1;31m]\033[1;33m TÃœM KULLANICILARI SÄ°L"
echo -e "\033[1;31m[\033[1;36m3\033[1;31m]\033[1;33m GERÄ° DÃ–N"
echo ""
read -p "$(echo -e "\033[1;32mâ—‡ NE YAPMAK Ä°STERSÄ°NÄ°Z\033[1;31m ?\033[1;37m : ")" -e -i 1 resp

# --- SeÃ§enek 1: Tek KullanÄ±cÄ± Silme ---
if [[ "$resp" = "1" ]]; then
    clear
    tput setaf 7 ; tput setab 4 ; tput bold ; printf '%32s%s%-13s\n' "ã…¤ğŸ‰ã…¤ğŸš®ã…¤SSH KullanÄ±cÄ±sÄ± Silmeã…¤ğŸš®ã…¤ğŸ‰ã…¤" ; tput sgr0
    echo ""
    echo -e "\033[1;33mâ—‡ KULLANICI LÄ°STESÄ°: \033[0m"
    echo ""
    _userT=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody)
    i=0
    unset _userPass
    # Sistemdeki tÃ¼m kullanÄ±cÄ±larÄ± numaralandÄ±rarak listele.
    while read _user; do
        i=$(expr $i + 1)
        _oP=$i
        [[ $i == [1-9] ]] && i=0$i && oP+=" 0$i"
        echo -e "\033[1;31m[\033[1;36m$i\033[1;31m] \033[1;37m- \033[1;32m$_user\033[0m"
        _userPass+="\n${_oP}:${_user}"
    done <<< "${_userT}"
    echo ""
    num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
    echo -ne "\033[1;32mâ—‡ Bir kullanÄ±cÄ± girin veya seÃ§in \033[1;33m[\033[1;36m1\033[1;31m-\033[1;36m$num_user\033[1;33m]\033[1;37m: " ; read option
    user=$(echo -e "${_userPass}" | grep -E "\b$option\b" | cut -d: -f2)

    if [[ -z $option ]] || [[ -z $user ]]; then
        tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo " â—‡ KullanÄ±cÄ± boÅŸ veya geÃ§ersiz!   " ; echo "" ; tput sgr0
        exit 1
    else
        # KullanÄ±cÄ±nÄ±n sistemde olup olmadÄ±ÄŸÄ±nÄ± kontrol et.
        if cat /etc/passwd | grep -w $user > /dev/null; then
            echo ""
            # KullanÄ±cÄ±nÄ±n aktif baÄŸlantÄ±larÄ±nÄ± sonlandÄ±r.
            pkill -f "$user" > /dev/null 2>&1
            # KullanÄ±cÄ±yÄ± sistemden sil.
            deluser --force $user > /dev/null 2>&1
            echo -e "\E[41;1;37mâ—‡ $user kullanÄ±cÄ±sÄ± baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±! \E[0m"
            # KullanÄ±cÄ±yÄ± veritabanÄ±ndan sil.
            grep -v "^$user[[:space:]]" /root/usuarios.db > /tmp/ph ; cat /tmp/ph > /root/usuarios.db
            rm /etc/VPSManager/senha/$user 1>/dev/null 2>/dev/null
            # OpenVPN kuruluysa, sertifikasÄ±nÄ± iptal et.
            if [[ -e /etc/openvpn/server.conf ]]; then
                remove_ovp $user
            fi
            exit 1
        else
            tput setaf 7 ; tput setab 4 ; tput bold ; echo "" ; echo "â—‡ $user kullanÄ±cÄ±sÄ± mevcut deÄŸil!" ; echo "" ; tput sgr0
        fi
    fi
# --- SeÃ§enek 2: TÃ¼m KullanÄ±cÄ±larÄ± Silme ---
elif [[ "$resp" = "2" ]]; then
    clear
    tput setaf 7 ; tput setab 4 ; tput bold ; printf '%32s%s%-13s\n' "ã…¤ğŸ‰ã…¤ğŸš®ã…¤TÃ¼m KullanÄ±cÄ±larÄ± Silã…¤ğŸš®ã…¤ğŸ‰ã…¤" ; tput sgr0
    echo ""
    echo -ne "\033[1;33mâ—‡ TÃœM KULLANICILARI GERÃ‡EKTEN SÄ°LMEK Ä°STÄ°YOR MUSUNUZ \033[1;37m[e/h]: "; read opc
    if [[ "$opc" = "e" ]]; then
        echo -e "\n\033[1;33mâ—‡ LÃ¼tfen Bekleyin...\033[1;32m.\033[1;31m.\033[1;33m.\033[0m"
        # Sistemdeki tÃ¼m normal kullanÄ±cÄ±lar iÃ§in dÃ¶ngÃ¼ baÅŸlat.
        for user in $(cat /etc/passwd | awk -F : '$3 > 900 {print $1}' | grep -vi "nobody"); do
            pkill -f $user > /dev/null 2>&1
            deluser --force $user > /dev/null 2>&1
            if [[ -e /etc/openvpn/server.conf ]]; then
               remove_ovp $user
            fi
        done
        # VeritabanÄ±nÄ± ve .zip dosyalarÄ±nÄ± temizle.
        rm $HOME/usuarios.db && touch $HOME/usuarios.db
        rm *.zip > /dev/null 2>&1
        echo -e "\n\033[1;32mâ—‡TÃœM KULLANICILAR BAÅARIYLA SÄ°LÄ°NDÄ°!\033[0m"
        sleep 2
        menu
    else
        echo -e "\n\033[1;31mâ—‡ MenÃ¼ye dÃ¶nÃ¼lÃ¼yor...\033[0m"
        sleep 2
        menu
    fi
# --- SeÃ§enek 3: Geri DÃ¶n ---
elif [[ "$resp" = "3" ]]; then
    menu
else
    echo -e "\n\033[1;31mâ—‡ GeÃ§ersiz seÃ§enek!\033[0m"
    sleep 1.5s
    menu
fi