#!/bin/bash
clear
# Gerekli ShellBot kÃ¼tÃ¼phanesini dahil et.
source ShellBot.sh

# Script'e verilen argÃ¼manlarÄ± (bot token'Ä± ve admin ID'si) al.
api_bot=$1
id_admin=$2

# ShellBot'u baÅŸlat.
ShellBot.init --token "$api_bot" --monitor --flush
ShellBot.username

# --- FONKSÄ°YON: Ana menÃ¼yÃ¼ gÃ¶sterir ---
menu() {
    # EÄŸer mesajÄ± gÃ¶nderen admin ise, menÃ¼ dÃ¼ÄŸmelerini gÃ¶ster.
    if [[ "${message_from_id[$id]}" == "$id_admin" ]]; then
        local msg
        msg="â—‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‡\n"
        msg+="<b>â€¢ğŸ”¹â€¢ã…¤ğŸ‰ã…¤Cyux VPS YÃ¶neticisiã…¤ğŸ‰ã…¤â€¢ğŸ”¹â€¢</b>\n"
        msg+="â—‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‡\n\n"
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e $msg)" \
            --reply_markup "$keyboard1" \
            --parse_mode html
        return 0
    fi
    # EÄŸer admin deÄŸilse, eriÅŸimi reddet.
    ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
        --text "$(echo -e ğŸš« ERÄ°ÅÄ°M REDDEDÄ°LDÄ° ğŸš«)"
    return 0
}

# --- FONKSÄ°YON: 30 gÃ¼nlÃ¼k SSH hesabÄ± oluÅŸturur ---
criarssh30() {
    # Rastgele bir kullanÄ±cÄ± adÄ± ve ÅŸifre oluÅŸtur.
    usuario=$(echo KULLANICI$(( RANDOM% + 999999)))
    senha=$((RANDOM% + 99999))
    limite='1'
    tempo='31' # GeÃ§erlilik sÃ¼resi (gÃ¼n)
    
    # Son kullanma tarihini sistem formatÄ±nda ve okunabilir formatta hesapla.
    final=$(date "+%Y-%m-%d" -d "+$tempo days")
    gui=$(date "+%d/%m/%Y" -d "+$tempo days")
    pass=$(perl -e 'print crypt($ARGV[0], "password")' $senha)
    
    # OluÅŸturulan kullanÄ±cÄ± adÄ± sistemde zaten var mÄ± diye kontrol et.
    if [[ "$(grep -wc $usuario /etc/passwd)" != '0' ]]; then
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id} \
            --text "â—‡ OLUÅTURULAN HESAP ZATEN MEVCUT! TEKRAR DENEYÄ°N."
        return 0
    else
        # KullanÄ±cÄ±yÄ± oluÅŸtur, ÅŸifresini ayarla ve veritabanlarÄ±na kaydet.
        useradd -e $final -M -s /bin/false -p $pass $usuario >/dev/null 2>&1
        (echo "$senha";echo "$senha") | passwd $usuario > /dev/null 2>&1
        echo "$senha" > /etc/VPSManager/senha/$usuario
        echo "$usuario $limite" >> /root/usuarios.db

        # KullanÄ±cÄ± bilgilerini Telegram'a gÃ¶nder.
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id} \
            --text "$(echo -e "âœ… <b>Hesap baÅŸarÄ±yla oluÅŸturuldu</b> âœ…\n\n<b>SUNUCU</b>: $(cat /etc/IP) \n<b>KULLANICI ADI</b>: <code>$usuario</code>\n<b>ÅÄ°FRE</b>: <code>$senha</code>\n<b>LÄ°MÄ°T</b>: 01\n\nâ³ Son Kullanma Tarihi: $gui ")" \
            --parse_mode html
        return 0
    fi
}

# --- FONKSÄ°YON: 15 gÃ¼nlÃ¼k SSH hesabÄ± oluÅŸturur ---
criarssh15() {
    # Rastgele bir kullanÄ±cÄ± adÄ± ve ÅŸifre oluÅŸtur.
    usuario=$(echo KULLANICI$(( RANDOM% + 999999)))
    senha=$((RANDOM% + 99999))
    limite='1'
    tempo='16' # GeÃ§erlilik sÃ¼resi (gÃ¼n)

    # Son kullanma tarihini hesapla.
    final=$(date "+%Y-%m-%d" -d "+$tempo days")
    gui=$(date "+%d/%m/%Y" -d "+$tempo days")
    pass=$(perl -e 'print crypt($ARGV[0], "password")' $senha)
    
    # KullanÄ±cÄ± adÄ± zaten var mÄ± diye kontrol et.
    if [[ "$(grep -wc $usuario /etc/passwd)" != '0' ]]; then
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id} \
            --text "â—‡ OLUÅTURULAN HESAP ZATEN MEVCUT! TEKRAR DENEYÄ°N."
        return 0
    else
        # KullanÄ±cÄ±yÄ± oluÅŸtur ve bilgilerini kaydet.
        useradd -e $final -M -s /bin/false -p $pass $usuario >/dev/null 2>&1
        (echo "$senha";echo "$senha") | passwd $usuario > /dev/null 2>&1
        echo "$senha" > /etc/VPSManager/senha/$usuario
        echo "$usuario $limite" >> /root/usuarios.db

        # KullanÄ±cÄ± bilgilerini Telegram'a gÃ¶nder.
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id} \
            --text "$(echo -e "âœ… <b>Hesap baÅŸarÄ±yla oluÅŸturuldu</b> âœ…\n\n<b>SUNUCU</b>: $(cat /etc/IP) \n<b>KULLANICI ADI</b>: <code>$usuario</code>\n<b>ÅÄ°FRE</b>: <code>$senha</code>\n<b>LÄ°MÄ°T</b>: 01\n\nâ³ Son Kullanma Tarihi: $gui ")" \
            --parse_mode html
        return 0
    fi
}

# --- FONKSÄ°YON: KullanÄ±cÄ±nÄ±n Telegram bilgilerini gÃ¶sterir ---
infouser () {
    ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
        --text "$(echo -e "Ä°sim:  ${message_from_first_name[$(ShellBot.ListUpdates)]}\nKullanÄ±cÄ±: @${message_from_username[$(ShellBot.ListUpdates)]:-null}")\nID: ${message_from_id[$(ShellBot.ListUpdates)]} " \
        --parse_mode html
    return 0
}

# --- DÃ¼ÄŸme TanÄ±mlamalarÄ± ---
unset botao1; botao1=''
ShellBot.InlineKeyboardButton --button 'botao1' --line 1 --text '30 GÃœNLÃœK SSH HESABI' --callback_data 'gerarssh30'
ShellBot.InlineKeyboardButton --button 'botao1' --line 2 --text '15 GÃœNLÃœK SSH HESABI' --callback_data 'gerarssh15'

# FonksiyonlarÄ± dÃ¼ÄŸme verilerine ata.
ShellBot.regHandleFunction --function criarssh30 --callback_data gerarssh30
ShellBot.regHandleFunction --function criarssh15 --callback_data gerarssh15

# DÃ¼ÄŸmeleri bir klavye dÃ¼zenine yerleÅŸtir.
unset keyboard1; keyboard1="$(ShellBot.InlineKeyboardMarkup -b 'botao1')"

# --- Ana Bot DÃ¶ngÃ¼sÃ¼ ---
# SÃ¼rekli olarak Telegram'dan gelen gÃ¼ncellemeleri dinler.
while :; do
    ShellBot.getUpdates --limit 100 --offset $(ShellBot.OffsetNext) --timeout 30
    for id in $(ShellBot.ListUpdates); do
        (
            # Bir dÃ¼ÄŸmeye tÄ±klandÄ±ysa, ilgili fonksiyonu Ã§alÄ±ÅŸtÄ±r.
            ShellBot.watchHandle --callback_data ${callback_query_data[$id]}
            
            # Gelen mesaj bir komut ise, ilgili fonksiyonu Ã§alÄ±ÅŸtÄ±r.
            comando=(${message_text[$id]})
            [[ "${comando[0]}" = "/menu"  || "${comando[0]}" = "/start" ]] && menu
            [[ "${comando[0]}" = "/id"    ]] && infouser
        ) &
    done
done