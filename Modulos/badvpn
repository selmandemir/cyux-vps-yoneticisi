#!/bin/bash
fun_badvpn() {
    clear
    # BaÅŸlÄ±k metnini mavi arka plan Ã¼zerine beyaz ve kalÄ±n olarak yazdÄ±r.
    echo -e "\E[44;1;37m        ã…¤ðŸ‰ã…¤BADVPN YÃ–NETÄ°CÄ°SÄ°ã…¤ðŸ‰ã…¤         \E[0m"
    echo ""
    
    # Badvpn (udpvpn) Ã§alÄ±ÅŸÄ±yorsa, hangi portlarÄ± kullandÄ±ÄŸÄ±nÄ± gÃ¶ster.
    if ps x | grep -w udpvpn | grep -v grep 1>/dev/null 2>/dev/null; then
        echo -e "\033[1;33mâ—‡ AKTÄ°F PORTLAR\033[1;37m: \033[1;32m$(netstat -nplt | grep 'badvpn-ud' | awk {'print $4'} | cut -d: -f2 | xargs)"
    else
        sleep 0.1
    fi
    
    # Badvpn'in Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± kontrol et ve menÃ¼de durumunu gÃ¶ster (â™¦ = Aktif, â—‹ = Pasif).
    var_sks1=$(ps x | grep "udpvpn" | grep -v grep > /dev/null && echo -e "\033[1;32mâ™¦ " || echo -e "\033[1;31mâ—‹ ")
    echo ""
    
    # MenÃ¼ seÃ§eneklerini listele.
    echo -e "\033[1;31m[\033[1;36m1\033[1;31m] \033[1;37mâ€¢ \033[1;33mBADVPN'i AÃ‡/KAPAT (Port 7300) $var_sks1 \033[0m"
    echo -e "\033[1;31m[\033[1;36m2\033[1;31m] \033[1;37mâ€¢ \033[1;33mÃ–ZEL PORT AÃ‡\033[0m"
    echo -e "\033[1;31m[\033[1;36m0\033[1;31m] \033[1;37mâ€¢ \033[1;33mGERÄ° DÃ–N\033[0m"
    echo ""
    
    # KullanÄ±cÄ±dan bir seÃ§im yapmasÄ±nÄ± iste.
    echo -ne "\033[1;32mâ—‡ NE YAPMAK Ä°STERSÄ°NÄ°Z \033[1;33m?\033[1;37m "
    read resposta
    
    if [[ "$resposta" = '1' ]]; then
        # EÄŸer Badvpn zaten Ã§alÄ±ÅŸÄ±yorsa, durdurma iÅŸlemini yap.
        if ps x | grep -w udpvpn | grep -v grep 1>/dev/null 2>/dev/null; then
            clear
            echo -e "\E[41;1;37m            BADVPN'i DURDURMA             \E[0m"
            echo ""
            # Badvpn'i durduran fonksiyon.
            fun_stopbad () {
                # 'udpvpn' adÄ±yla Ã§alÄ±ÅŸan tÃ¼m screen oturumlarÄ±nÄ± bul ve sonlandÄ±r.
                for pidudpvpn in $(screen -ls | grep ".udpvpn" | awk {'print $1'}); do
                    screen -r -S "$pidudpvpn" -X quit
                done
                # Otomatik baÅŸlatma dosyasÄ±ndan Badvpn satÄ±rÄ±nÄ± sil.
                [[ $(grep -wc "udpvpn" /etc/autostart) != '0' ]] && {
                    sed -i '/udpvpn/d' /etc/autostart
                }
                sleep 1
                screen -wipe >/dev/null
            }
            echo -e "\033[1;32mâ—‡ BADVPN DEVRE DIÅžI BIRAKILIYOR\033[1;33m"
            echo ""
            fun_stopbad
            echo ""
            echo -e "\033[1;32mâ—‡ BADVPN BAÅžARIYLA DEVRE DIÅžI BIRAKILDI!\033[1;33m"
            sleep 3
            fun_badvpn
        else
            # EÄŸer Badvpn Ã§alÄ±ÅŸmÄ±yorsa, baÅŸlatma iÅŸlemini yap.
            clear
            echo -e "\033[1;32mâ—‡ BADVPN BAÅžLATILIYOR... \033[0m\n"
            # Badvpn'i baÅŸlatan ve otomatik baÅŸlatmaya ekleyen fonksiyon.
            fun_udpon () {
                screen -dmS udpvpn /bin/badvpn-udpgw --listen-addr 127.0.0.1:7300 --max-clients 10000 --max-connections-for-client 8
                # /etc/autostart dosyasÄ±na ekle ki sistem yeniden baÅŸlayÄ±nca Ã§alÄ±ÅŸsÄ±n.
                if [[ $(grep -wc "udpvpn" /etc/autostart) = '0' ]]; then
                    echo "ps x | grep 'udpvpn' | grep -v 'grep' || screen -dmS udpvpn /bin/badvpn-udpgw --listen-addr 127.0.0.1:7300 --max-clients 10000 --max-connections-for-client 8 --client-socket-sndbuf 10000" >> /etc/autostart
                fi
                sleep 1
            }
            # Badvpn programÄ± kurulu deÄŸilse indiren fonksiyon.
            inst_udp () {
                if [[ ! -e "/bin/badvpn-udpgw" ]]; then
                    cd $HOME
                    wget https://github.com/selmandemir/cyux-vps-yoneticisi/raw/main/Modulos/badvpn-udpgw -o /dev/null
                    mv -f $HOME/badvpn-udpgw /bin/badvpn-udpgw
                    chmod 777 /bin/badvpn-udpgw
                fi
            }
            echo ""
            inst_udp
            fun_udpon
            echo ""
            echo -e "\033[1;32mâ—‡ BADVPN BAÅžARIYLA AKTÄ°F EDÄ°LDÄ°\033[1;33m"
            sleep 3
            fun_badvpn
        fi
    elif [[ "$resposta" = '2' ]]; then
        # Ã–zel bir portta Badvpn baÅŸlatma seÃ§eneÄŸi.
        if ps x | grep -w udpvpn | grep -v grep 1>/dev/null 2>/dev/null; then
            clear
            echo -e "\E[44;1;37m             Ã–ZEL PORTTA BADVPN             \E[0m"
            echo ""
            echo -ne "\033[1;32mâ—‡ HANGÄ° PORTU KULLANMAK Ä°STERSÄ°NÄ°Z \033[1;33m?\033[1;37m: "
            read porta
            if [[ -z "$porta" ]]; then
                echo ""
                echo -e "\033[1;31mâ—‡ GeÃ§ersiz port!"
                sleep 2
                fun_badvpn
            fi
            echo ""
            echo -e "\033[1;32mâ—‡ BADVPN, \033[1;31m$porta\033[1;32m PORTUNDA BAÅžLATILIYOR\033[1;33m"
            echo ""
            # Belirtilen portta Badvpn'i baÅŸlatan fonksiyon.
            fun_abrirptbad() {
                sleep 1
                screen -dmS udpvpn /bin/badvpn-udpgw --listen-addr 127.0.0.1:$porta --max-clients 10000 --max-connections-for-client 8
                sleep 1
            }
            fun_abrirptbad
            echo ""
            echo -e "\033[1;32mâ—‡ BADVPN BAÅžARIYLA AKTÄ°F EDÄ°LDÄ°\033[1;33m"
            sleep 2
            fun_badvpn
        else
            clear
            echo -e "\033[1;31mâ—‡ BU FONKSÄ°YON KULLANILAMAZ\n\n\033[1;33mÃ–NCE BADVPN'i [1] SEÃ‡ENEÄžÄ° Ä°LE AKTÄ°F EDÄ°N!\033[1;33m"
            sleep 3
            fun_badvpn
        fi
    elif [[ "$resposta" = '0' ]]; then
        # MenÃ¼ye geri dÃ¶nme seÃ§eneÄŸi.
        echo ""
        echo -e "\033[1;31mâ—‡ Geri dÃ¶nÃ¼lÃ¼yor...\033[0m"
        sleep 1
        menu
    else
        # GeÃ§ersiz seÃ§enek.
        echo ""
        echo -e "\033[1;31mâ—‡ GeÃ§ersiz seÃ§enek!\033[0m"
        sleep 1
        fun_badvpn
    fi
}
fun_badvpn