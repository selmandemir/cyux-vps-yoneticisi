#!/bin/bash
clear
# BaÅŸlÄ±k metnini mavi arka plan Ã¼zerine beyaz ve kalÄ±n olarak yazdÄ±r.
tput setaf 7 ; tput setab 4 ; tput bold ; printf '%33s%s%-12s\n' "ğŸ‰ã…¤ğŸ“…ã…¤KullanÄ±cÄ± SÃ¼resini DeÄŸiÅŸtirmeã…¤ğŸ“…ã…¤ğŸ‰" ; tput sgr0
echo ""
echo -e "\033[1;33mâ—‡ KULLANICI LÄ°STESÄ° VE SON KULLANMA TARÄ°HLERÄ°:\033[0m "
echo ""
tput setaf 7 ; tput bold 

# KullanÄ±cÄ± veritabanÄ± dosyasÄ±nÄ±n yolu.
database="/root/usuarios.db"
# Sistemdeki normal kullanÄ±cÄ±larÄ± listele.
list_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody)
i=0
unset _userPass

# Her bir kullanÄ±cÄ± iÃ§in bir dÃ¶ngÃ¼ baÅŸlat ve bilgilerini gÃ¶ster.
while read user; do
    i=$(expr $i + 1)
    _oP=$i
    [[ $i == [1-9] ]] && i=0$i && oP+=" 0$i"
    
    # KullanÄ±cÄ±nÄ±n son kullanma tarihini 'chage' komutuyla al.
    expire="$(chage -l $user | grep -E "Account expires" | cut -d ' ' -f3-)"
    
    if [[ $expire == "never" ]]; then
        # EÄŸer hesabÄ±n sÃ¼resi "hiÃ§bir zaman" dolmuyorsa.
        echo -e "\033[1;31m[\033[1;36m$i\033[1;31m] \033[1;37m- \033[1;32m$user       \033[1;33mSÃœRESÄ°Z HESAP\033[0m"
    else
        databr="$(date -d "$expire" +"%Y%m%d")"
        hoje="$(date -d today +"%Y%m%d")"
        if [ $hoje -ge $databr ]; then
            # EÄŸer tarih geÃ§miÅŸse.
            _user=$(echo -e "\033[1;31m[\033[1;36m$i\033[1;31m] \033[1;37m- \033[1;32m$user\033[1;37m")
            datanormal="$(echo -e "\033[1;31m$(date -d"$expire" '+%d/%m/%Y')")"
            expired=$(echo -e "\033[1;31mâ—‡ã…¤SÃœRESÄ° DOLMUÅ\033[0m")
            printf '%-62s%-20s%s\n' "$_user" "$datanormal" "$expired"
        else
            # EÄŸer hala geÃ§erliyse.
            _user=$(echo -e "\033[1;31m[\033[1;36m$i\033[1;31m] \033[1;37m- \033[1;32m$user\033[1;37m")
            datanormal="$(echo -e "\033[1;33m$(date -d"$expire" '+%d/%m/%Y')")"
            ative=$(echo -e "\033[1;32mâ—‡ã…¤GEÃ‡ERLÄ°\033[0m")
            printf '%-62s%-20s%s\n' "$_user" "$datanormal" "$ative"
        fi
    fi
    # Daha sonra kolay seÃ§im iÃ§in kullanÄ±cÄ± listesini bir deÄŸiÅŸkende biriktir.
    _userPass+="\n${_oP}:${user}"
done <<< "${list_user}"
tput sgr0
echo ""

# KullanÄ±cÄ±dan bir seÃ§im yapmasÄ±nÄ± iste.
num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
echo -ne "\033[1;32mâ—‡ã…¤Bir kullanÄ±cÄ± girin veya seÃ§in \033[1;33m[\033[1;36m1\033[1;33m-\033[1;36m$num_user\033[1;33m]\033[1;37m: " ; read option

# SeÃ§ilen numaraya karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ±nÄ± bul.
usuario=$(echo -e "${_userPass}" | grep -E "\b$option\b" | cut -d: -f2 | sed 's/\x1b\[[0-9;]*m//g' | sed 's/ //g')

# EÄŸer giriÅŸ boÅŸ veya geÃ§ersizse hata ver.
if [[ -z $option ]] || [[ -z $usuario ]]; then
    echo ""
    tput setaf 7 ; tput setab 1 ; tput bold ; echo "â—‡ã…¤Hata, BoÅŸ veya GeÃ§ersiz KullanÄ±cÄ± AdÄ±! " ; tput sgr0
    exit 1
else
    # SeÃ§ilen kullanÄ±cÄ± sistemde gerÃ§ekten var mÄ± diye kontrol et.
    if [[ `grep -c "/$usuario:" /etc/passwd` -ne 0 ]]; then
        echo ""
        echo -e "\033[1;31mâ—‡Ã–RNEK:\033[1;33m(\033[1;32mTARÄ°H: \033[1;37mGÃœN/AY/YIL \033[1;33mveya \033[1;32mGÃœN SAYISI: \033[1;37m30\033[1;33m)"
        echo ""
        echo -ne "\033[1;32mâ—‡ã…¤\033[1;33m$usuario\033[1;32m kullanÄ±cÄ±sÄ± iÃ§in yeni tarih veya gÃ¼n sayÄ±sÄ±: \033[1;37m"; read inputdate
        
        # Girilen verinin gÃ¼n sayÄ±sÄ± mÄ± yoksa tam tarih mi olduÄŸunu kontrol et.
        if [[ "$(echo -e "$inputdate" | grep -c "/")" = "0" ]]; then 
            # EÄŸer gÃ¼n sayÄ±sÄ± ise, bugÃ¼nÃ¼n tarihine ekleyerek tam tarihi hesapla.
            udata=$(date "+%d/%m/%Y" -d "+$inputdate days")
            sysdate="$(echo "$udata" | awk -v FS=/ -v OFS=- '{print $3,$2,$1}')"
        else
            # EÄŸer tam tarih ise, doÄŸrudan kullan.
            udata=$(echo -e "$inputdate")
            sysdate="$(echo "$inputdate" | awk -v FS=/ -v OFS=- '{print $3,$2,$1}')"
        fi
        
        # Girilen tarihin geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol et.
        if (date "+%Y-%m-%d" -d "$sysdate" > /dev/null 2>&1); then
            if [[ -z $inputdate ]]; then
                echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "â—‡ã…¤GeÃ§ersiz veya boÅŸ bir tarih girdiniz!" ; echo "GeÃ§erli bir tarih girin: GÃœN/AY/YIL" ; echo "Ã–rnek: 21/04/2025" ; tput sgr0 ; echo ""; exit 1
            else
                # Girilen tarihin geÃ§miÅŸ bir tarih olup olmadÄ±ÄŸÄ±nÄ± kontrol et.
                today="$(date -d today +"%Y%m%d")"
                timemachine="$(date -d "$sysdate" +"%Y%m%d")"
                if [ $today -ge $timemachine ]; then
                    echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "â—‡ã…¤GeÃ§miÅŸ veya geÃ§ersiz bir tarih girdiniz!" ; echo "Gelecekteki geÃ§erli bir tarihi girin: GÃœN/AY/YIL" ; echo "Ã–rnek: 21/04/2025" ; tput sgr0; echo ""; exit 1
                else
                    # TÃ¼m kontrollerden geÃ§tiyse, 'chage' komutuyla kullanÄ±cÄ±nÄ±n son kullanma tarihini gÃ¼ncelle.
                    chage -E $sysdate $usuario
                    echo ""
                    tput setaf 7 ; tput setab 4 ; tput bold ; echo "â—‡ã…¤BaÅŸarÄ±lÄ±! $usuario kullanÄ±cÄ±sÄ±nÄ±n yeni tarihi: $udata " ; tput sgr0
                    echo ""
                    exit 1
                fi
            fi
        else
            echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "â—‡ã…¤GeÃ§ersiz veya boÅŸ bir tarih girdiniz!" ; echo "GeÃ§erli bir tarih girin: GÃœN/AY/YIL" ; echo "Ã–rnek: 21/04/2025" ; tput sgr0; echo ""; exit 1
        fi
    else
        echo " "; tput setaf 7 ; tput setab 1 ; tput bold ; echo "â—‡ã…¤$usuario kullanÄ±cÄ±sÄ± mevcut deÄŸil!" ; tput sgr0; echo " "; exit 1
    fi
fi