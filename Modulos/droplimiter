#!/bin/bash
# KullanÄ±cÄ± limitlerinin saklandÄ±ÄŸÄ± veritabanÄ± dosyasÄ±nÄ±n yolu.
database="/root/usuarios.db"
# Bu script'in process ID'sini (PID) geÃ§ici bir dosyaya yaz.
echo $$ > /tmp/pids

# --- FONKSÄ°YON: Aktif Dropbear baÄŸlantÄ±larÄ±nÄ± ve kullanÄ±cÄ±larÄ±nÄ± listeler ---
fun_drop () {
    # Dropbear'Ä±n Ã§alÄ±ÅŸtÄ±ÄŸÄ± portu bul.
    port_dropbear=`ps aux | grep dropbear | awk NR==1 | awk '{print $17;}'`
    log=/var/log/auth.log
    loginsukses='Password auth succeeded' # Sistem loglarÄ±ndaki baÅŸarÄ±lÄ± giriÅŸ metni
    clear
    # Dropbear'a ait tÃ¼m aktif process ID'lerini (PID) bul.
    pids=`ps ax |grep dropbear |grep " $port_dropbear" |awk -F" " '{print $1}'`
    for pid in $pids; do
        pidlogs=`grep $pid $log |grep "$loginsukses" |awk -F" " '{print $3}'`
        i=0
        for pidend in $pidlogs; do
            let i=i+1
        done
        if [ $pidend ]; then
            # Log dosyasÄ±ndan kullanÄ±cÄ± adÄ±, PID ve giriÅŸ zamanÄ±nÄ± Ã§ek.
            login=`grep $pid $log |grep "$pidend" |grep "$loginsukses"`
            PID=$pid
            user=`echo $login |awk -F" " '{print $10}' | sed -r "s/'/ /g"`
            waktu=`echo $login |awk -F" " '{print $2"-"$1,$3}'`
            # Ã‡Ä±ktÄ±yÄ± dÃ¼zgÃ¼n formatlamak iÃ§in boÅŸluk ekle.
            while [ ${#waktu} -lt 13 ]; do waktu=$waktu" "; done
            while [ ${#user} -lt 16 ]; do user=$user" "; done
            while [ ${#PID} -lt 8 ]; do PID=$PID" "; done
            # FormatlanmÄ±ÅŸ bilgiyi yazdÄ±r.
            echo "$user $PID $waktu"
        fi
    done
} 

# EÄŸer kullanÄ±cÄ± veritabanÄ± dosyasÄ± yoksa hata ver ve Ã§Ä±k.
if [ ! -f "$database" ]; then
    echo "â—‡ /root/usuarios.db dosyasÄ± bulunamadÄ±!"
    exit 1
fi

# --- ANA DÃ–NGÃœ: KullanÄ±cÄ±larÄ± sÃ¼rekli olarak izler ---
while true; do
    clear
    # BaÅŸlÄ±k metnini yeÅŸil arka plan Ã¼zerine beyaz ve kalÄ±n olarak yazdÄ±r.
    echo -e "\E[42;1;37m        ã…¤ğŸ‰ã…¤DROPBEAR BAÄLANTI SINIRLAYICIã…¤ğŸ‰ã…¤         \E[0m"
    echo -e "\E[42;1;37mâ—‡KullanÄ±cÄ±                               â—‡BaÄŸlantÄ±Â¦Limit\E[0m"
    
    # VeritabanÄ±ndaki her bir kullanÄ±cÄ± iÃ§in dÃ¶ngÃ¼ baÅŸlat.
    while read usline; do
        user="$(echo $usline | cut -d' ' -f1)"
        s2ssh="$(echo $usline | cut -d' ' -f2)" # KullanÄ±cÄ±nÄ±n izin verilen limiti
        s3drop="$(fun_drop | grep "$user" | wc -l)" # KullanÄ±cÄ±nÄ±n anlÄ±k baÄŸlantÄ± sayÄ±sÄ±
        
        if [ -z "$user" ]; then
            # BoÅŸ satÄ±rlarÄ± atla.
            echo "" > /dev/null
        else
            # KullanÄ±cÄ±nÄ±n fazla baÄŸlantÄ±larÄ±nÄ±n PID'lerini geÃ§ici bir dosyaya yaz.
            fun_drop | grep "$user" | awk '{print $2}' |cut -d' ' -f2 > /tmp/userpid
            sed -n '2 p' /tmp/userpid > /tmp/tmp2 # Sadece limiti aÅŸan ikinci ve sonraki baÄŸlantÄ±yÄ± al
            rm /tmp/userpid
            
            # KullanÄ±cÄ± adÄ±nÄ± ve (anlÄ±k baÄŸlantÄ± / limit) durumunu ekrana yazdÄ±r.
            tput setaf 3 ; tput bold ; printf '  %-35s%s\n' $user $s3drop/$s2ssh; tput sgr0
            
            # EÄŸer anlÄ±k baÄŸlantÄ± sayÄ±sÄ±, izin verilen limitten fazlaysa...
            if [ "$s3drop" -gt "$s2ssh" ]; then
                echo -e "\E[41;1;37mâ—‡ KullanÄ±cÄ±nÄ±n limiti aÅŸtÄ±ÄŸÄ± iÃ§in baÄŸlantÄ±sÄ± kesildi! \E[0m"
                # Limiti aÅŸan baÄŸlantÄ±larÄ±n PID'lerini oku ve kill komutuyla sonlandÄ±r.
                while read line; do
                    tmp="$(echo $line | cut -d' ' -f1)"
                    kill $tmp
                done < /tmp/tmp2
                rm /tmp/tmp2
            fi
        fi
    done < "$database"
    # 6 saniye bekle ve dÃ¶ngÃ¼yÃ¼ tekrar baÅŸlat.
    sleep 6
done