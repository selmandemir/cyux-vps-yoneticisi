#!/bin/bash
IP=$(cat /etc/IP)

# Test kullanıcılarının silme script'lerini saklamak için bir dizin oluştur.
if [ ! -d /etc/VPSManager/userteste ]; then
    mkdir /etc/VPSManager/userteste
fi

# Başlık metnini mavi arka plan üzerine beyaz ve kalın olarak yazdır.
tput setaf 7 ; tput setab 4 ; tput bold ; printf '%30s%s%-15s\n' "Test Kullanıcısı Oluştur" ; tput sgr0
echo ""

# Mevcut aktif test kullanıcılarını listele.
if [ "$(ls -A /etc/VPSManager/userteste)" ]; then
    echo -e "\033[1;32mAktif Test Kullanıcıları:\033[1;37m"
else
    echo -e "\033[1;31mAktif test kullanıcısı yok!\033[0m"
fi
echo ""
for testeson in $(ls /etc/VPSManager/userteste | sort | sed 's/.sh//g'); do
    echo "$testeson"
done
echo ""

# Kullanıcıdan yeni test kullanıcısı için bilgileri al.
echo -ne "\033[1;32mKullanıcı Adı\033[1;37m: "; read nome
if [[ -z $nome ]]; then
    echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "Boş veya geçersiz isim." ; echo "" ; tput sgr0
    exit 1
fi

# Kullanıcı adının sistemde mevcut olup olmadığını kontrol et.
awk -F : ' { print $1 }' /etc/passwd > /tmp/users 
if grep -Fxq "$nome" /tmp/users; then
    tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "Bu kullanıcı zaten mevcut." ; echo "" ; tput sgr0
    exit 1
fi

echo -ne "\033[1;32mŞifre\033[1;37m: "; read pass
if [[ -z $pass ]]; then
    echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "Boş veya geçersiz şifre." ; echo "" ; tput sgr0
    exit 1
fi

echo -ne "\033[1;32mLimit\033[1;37m: "; read limit
if [[ -z $limit ]]; then
    echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "Boş veya geçersiz limit." ; echo "" ; tput sgr0
    exit 1
fi

echo -ne "\033[1;32mGeçerlilik Süresi \033[1;33m(\033[1;31mÖrnek: \033[1;37m60\033[1;33m)\033[1;37m: "; read u_temp
if [[ -z $u_temp ]]; then
    echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "Boş veya geçersiz süre." ; echo "" ; tput sgr0
    exit 1
fi

# --- Kullanıcı Oluşturma ve Zamanlama ---
# Kullanıcıyı oluştur.
useradd -M -s /bin/false $nome
# Şifresini ayarla.
(echo $pass;echo $pass) |passwd $nome > /dev/null 2>&1
# Şifreyi ileride göstermek için bir dosyaya kaydet.
echo "$pass" > /etc/VPSManager/senha/$nome
# Kullanıcıyı ve limitini veritabanına ekle.
echo "$nome $limit" >> /root/usuarios.db

# Belirtilen süre sonunda kullanıcıyı otomatik olarak silecek bir script oluştur.
echo "#!/bin/bash
pkill -f \"$nome\"
userdel --force $nome
grep -v ^$nome[[:space:]] /root/usuarios.db > /tmp/ph ; cat /tmp/ph > /root/usuarios.db
rm /etc/VPSManager/senha/$nome > /dev/null 2>&1
rm -rf /etc/VPSManager/userteste/$nome.sh
exit" > /etc/VPSManager/userteste/$nome.sh
chmod +x /etc/VPSManager/userteste/$nome.sh

# Otomatik silme script'ini 'at' komutuyla belirtilen dakika sonra çalışacak şekilde zamanla.
at -f /etc/VPSManager/userteste/$nome.sh now + $u_temp min > /dev/null 2>&1

# --- Sonuç Ekranı ---
clear
    echo -e "\033[1;32m===================================="
    echo -e "\033[1;32m   🐉ㅤCyux VPS Yöneticisiㅤ🐉   " 
    echo -e "\033[1;32m===================================="
    echo ""
    echo -e "\033[1;31m◈─────⪧ ÖNEMLİ UYARILAR ⪦──────◈"
    echo ""
    echo -e "\033[1;32m◈⪧ 🚫 SPAM Yasaktır"
    echo -e "\033[1;32m◈⪧ ⚠️ DDOS Yasaktır"
    echo -e "\033[1;32m◈⪧ 🎭 Hacking Yasaktır"
    echo -e "\033[1;32m◈⪧ ⛔️ Carding Yasaktır"
    echo -e "\033[1;32m◈⪧ 🙅‍♂️ Torrent Yasaktır"
    echo -e "\033[1;32m◈⪧ ❌ Çoklu Giriş Yasaktır"
    echo -e "\033[1;32m◈⪧ 🤷‍♂️ Yasa Dışı Aktiviteler Yasaktır"
    echo ""
    echo -e "\033[1;37m◈─────⪧ TEST SSH HESABI ⪦─────◈"
    echo ""
    echo -e "\033[1;32m◈ Sunucu / IP   :⪧  \033[1;31m$IP"
    echo -e "\033[1;32m◈ Kullanıcı Adı :⪧  \033[1;31m$nome"
    echo -e "\033[1;32m◈ Şifre         :⪧  \033[1;31m$pass"
    echo -e "\033[1;32m◈ Bağlantı Limiti:⪧  \033[1;31m$limit"
    echo -e "\033[1;32m◈ Geçerlilik Süresi:⪧  \033[1;31m$u_temp dakika"
    echo ""
    echo -e "\033[1;37m◈──────⪧ PORTLAR ⪦ ───────◈"
    echo ""
    echo -e "\033[1;32m◈ SSH      ⌁   22"
    echo -e "\033[1;32m◈ SSL      ⌁  443"
    echo -e "\033[1;32m◈ Squid    ⌁  8080"
    echo -e "\033[1;32m◈ DropBear ⌁   80"
    echo -e "\033[1;32m◈ BadVPN   ⌁  7300"
    echo ""
    echo -e "\033[1;37m◈───⪧ÇEVRİMİÇİ KULLANICI SAYISI⪦────◈ "
    echo ""
    echo -e "\033[1;32mhttp://$IP:8888/server/online"
    echo ""
    echo -e "\033[1;37m◈─────────────────────────────────◈"
    echo -e "\033[1;37m©️ 🐉   Cyux VPS Yöneticisi Script'i   🐉"
    echo -e "\033[1;37m◈─────────────────────────────────◈"
    echo ""
    echo -e "\033[1;33mBelirtilen süre sonunda \033[1;32m$nome\033[1;33m kullanıcısının"
    echo -e "\033[1;33mbağlantısı kesilecek ve hesap silinecektir.\033[0m"
exit