#!/bin/bash
IP=$(cat /etc/IP)

# Test kullanÄ±cÄ±larÄ±nÄ±n silme script'lerini saklamak iÃ§in bir dizin oluÅŸtur.
if [ ! -d /etc/VPSManager/userteste ]; then
    mkdir /etc/VPSManager/userteste
fi

# BaÅŸlÄ±k metnini mavi arka plan Ã¼zerine beyaz ve kalÄ±n olarak yazdÄ±r.
tput setaf 7 ; tput setab 4 ; tput bold ; printf '%30s%s%-15s\n' "Test KullanÄ±cÄ±sÄ± OluÅŸtur" ; tput sgr0
echo ""

# Mevcut aktif test kullanÄ±cÄ±larÄ±nÄ± listele.
if [ "$(ls -A /etc/VPSManager/userteste)" ]; then
    echo -e "\033[1;32mAktif Test KullanÄ±cÄ±larÄ±:\033[1;37m"
else
    echo -e "\033[1;31mAktif test kullanÄ±cÄ±sÄ± yok!\033[0m"
fi
echo ""
for testeson in $(ls /etc/VPSManager/userteste | sort | sed 's/.sh//g'); do
    echo "$testeson"
done
echo ""

# KullanÄ±cÄ±dan yeni test kullanÄ±cÄ±sÄ± iÃ§in bilgileri al.
echo -ne "\033[1;32mKullanÄ±cÄ± AdÄ±\033[1;37m: "; read nome
if [[ -z $nome ]]; then
    echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "BoÅŸ veya geÃ§ersiz isim." ; echo "" ; tput sgr0
    exit 1
fi

# KullanÄ±cÄ± adÄ±nÄ±n sistemde mevcut olup olmadÄ±ÄŸÄ±nÄ± kontrol et.
awk -F : ' { print $1 }' /etc/passwd > /tmp/users 
if grep -Fxq "$nome" /tmp/users; then
    tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "Bu kullanÄ±cÄ± zaten mevcut." ; echo "" ; tput sgr0
    exit 1
fi

echo -ne "\033[1;32mÅifre\033[1;37m: "; read pass
if [[ -z $pass ]]; then
    echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "BoÅŸ veya geÃ§ersiz ÅŸifre." ; echo "" ; tput sgr0
    exit 1
fi

echo -ne "\033[1;32mLimit\033[1;37m: "; read limit
if [[ -z $limit ]]; then
    echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "BoÅŸ veya geÃ§ersiz limit." ; echo "" ; tput sgr0
    exit 1
fi

echo -ne "\033[1;32mGeÃ§erlilik SÃ¼resi \033[1;33m(\033[1;31mÃ–rnek: \033[1;37m60\033[1;33m)\033[1;37m: "; read u_temp
if [[ -z $u_temp ]]; then
    echo ""; tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "BoÅŸ veya geÃ§ersiz sÃ¼re." ; echo "" ; tput sgr0
    exit 1
fi

# --- KullanÄ±cÄ± OluÅŸturma ve Zamanlama ---
# KullanÄ±cÄ±yÄ± oluÅŸtur.
useradd -M -s /bin/false $nome
# Åifresini ayarla.
(echo $pass;echo $pass) |passwd $nome > /dev/null 2>&1
# Åifreyi ileride gÃ¶stermek iÃ§in bir dosyaya kaydet.
echo "$pass" > /etc/VPSManager/senha/$nome
# KullanÄ±cÄ±yÄ± ve limitini veritabanÄ±na ekle.
echo "$nome $limit" >> /root/usuarios.db

# Belirtilen sÃ¼re sonunda kullanÄ±cÄ±yÄ± otomatik olarak silecek bir script oluÅŸtur.
echo "#!/bin/bash
pkill -f \"$nome\"
userdel --force $nome
grep -v ^$nome[[:space:]] /root/usuarios.db > /tmp/ph ; cat /tmp/ph > /root/usuarios.db
rm /etc/VPSManager/senha/$nome > /dev/null 2>&1
rm -rf /etc/VPSManager/userteste/$nome.sh
exit" > /etc/VPSManager/userteste/$nome.sh
chmod +x /etc/VPSManager/userteste/$nome.sh

# Otomatik silme script'ini 'at' komutuyla belirtilen dakika sonra Ã§alÄ±ÅŸacak ÅŸekilde zamanla.
at -f /etc/VPSManager/userteste/$nome.sh now + $u_temp min > /dev/null 2>&1

# --- SonuÃ§ EkranÄ± ---
clear
    echo -e "\033[1;32m===================================="
    echo -e "\033[1;32m   ğŸ‰ã…¤Cyux VPS YÃ¶neticisiã…¤ğŸ‰   " 
    echo -e "\033[1;32m===================================="
    echo ""
    echo -e "\033[1;31mâ—ˆâ”€â”€â”€â”€â”€âª§ Ã–NEMLÄ° UYARILAR âª¦â”€â”€â”€â”€â”€â”€â—ˆ"
    echo ""
    echo -e "\033[1;32mâ—ˆâª§ ğŸš« SPAM YasaktÄ±r"
    echo -e "\033[1;32mâ—ˆâª§ âš ï¸ DDOS YasaktÄ±r"
    echo -e "\033[1;32mâ—ˆâª§ ğŸ­ Hacking YasaktÄ±r"
    echo -e "\033[1;32mâ—ˆâª§ â›”ï¸ Carding YasaktÄ±r"
    echo -e "\033[1;32mâ—ˆâª§ ğŸ™…â€â™‚ï¸ Torrent YasaktÄ±r"
    echo -e "\033[1;32mâ—ˆâª§ âŒ Ã‡oklu GiriÅŸ YasaktÄ±r"
    echo -e "\033[1;32mâ—ˆâª§ ğŸ¤·â€â™‚ï¸ Yasa DÄ±ÅŸÄ± Aktiviteler YasaktÄ±r"
    echo ""
    echo -e "\033[1;37mâ—ˆâ”€â”€â”€â”€â”€âª§ TEST SSH HESABI âª¦â”€â”€â”€â”€â”€â—ˆ"
    echo ""
    echo -e "\033[1;32mâ—ˆ Sunucu / IP   :âª§  \033[1;31m$IP"
    echo -e "\033[1;32mâ—ˆ KullanÄ±cÄ± AdÄ± :âª§  \033[1;31m$nome"
    echo -e "\033[1;32mâ—ˆ Åifre         :âª§  \033[1;31m$pass"
    echo -e "\033[1;32mâ—ˆ BaÄŸlantÄ± Limiti:âª§  \033[1;31m$limit"
    echo -e "\033[1;32mâ—ˆ GeÃ§erlilik SÃ¼resi:âª§  \033[1;31m$u_temp dakika"
    echo ""
    echo -e "\033[1;37mâ—ˆâ”€â”€â”€â”€â”€â”€âª§ PORTLAR âª¦ â”€â”€â”€â”€â”€â”€â”€â—ˆ"
    echo ""
    echo -e "\033[1;32mâ—ˆ SSH      âŒ   22"
    echo -e "\033[1;32mâ—ˆ SSL      âŒ  443"
    echo -e "\033[1;32mâ—ˆ Squid    âŒ  8080"
    echo -e "\033[1;32mâ—ˆ DropBear âŒ   80"
    echo -e "\033[1;32mâ—ˆ BadVPN   âŒ  7300"
    echo ""
    echo -e "\033[1;37mâ—ˆâ”€â”€â”€âª§Ã‡EVRÄ°MÄ°Ã‡Ä° KULLANICI SAYISIâª¦â”€â”€â”€â”€â—ˆ "
    echo ""
    echo -e "\033[1;32mhttp://$IP:8888/server/online"
    echo ""
    echo -e "\033[1;37mâ—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ"
    echo -e "\033[1;37mÂ©ï¸ ğŸ‰   Cyux VPS YÃ¶neticisi Script'i   ğŸ‰"
    echo -e "\033[1;37mâ—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ"
    echo ""
    echo -e "\033[1;33mBelirtilen sÃ¼re sonunda \033[1;32m$nome\033[1;33m kullanÄ±cÄ±sÄ±nÄ±n"
    echo -e "\033[1;33mbaÄŸlantÄ±sÄ± kesilecek ve hesap silinecektir.\033[0m"
exit