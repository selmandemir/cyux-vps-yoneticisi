#!/bin/bash
clear
# BetiÄŸin bir argÃ¼manla mÄ± yoksa argÃ¼mansÄ±z mÄ± Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nÄ± kontrol et.
backbot=$1

# EÄŸer argÃ¼mansÄ±z Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ysa, interaktif menÃ¼yÃ¼ gÃ¶ster.
[[ -z $backbot ]] && {
    IP=$(wget -qO- ipv4.icanhazip.com)
    
    # --- FONKSÄ°YON: Ä°ndirme linki iÃ§in Apache web sunucusunu kurar veya ayarlar ---
    apchon () {
        if netstat -nltp|grep 'apache2' > /dev/null; then
            # Apache zaten kuruluysa, sadece gerekli dizinleri oluÅŸtur.
            [[ ! -d /var/www/html ]] && mkdir /var/www/html
            [[ ! -d /var/www/html/backup ]] && mkdir /var/www/html/backup
            touch /var/www/html/backup/index.html
            /etc/init.d/apache2 restart
        else
            # Apache kurulu deÄŸilse, kur ve ayarla.
            apt-get install apache2 zip -y
            sed -i "s/Listen 80/Listen 8888/g" /etc/apache2/ports.conf
            service apache2 restart
            [[ ! -d /var/www/html ]] && mkdir /var/www/html
            [[ ! -d /var/www/html/backup ]] && mkdir /var/www/html/backup
            touch /var/www/html/backup/index.html
            chmod -R 755 /var/www
            /etc/init.d/apache2 restart
        fi
    }
    
    # --- FONKSÄ°YON: Ä°ÅŸlem sÄ±rasÄ±nda bekleme animasyonu gÃ¶sterir ---
    fun_temp () {
        helice () {
            apchon > /dev/null 2>&1 & 
            tput civis
            while [ -d /proc/$! ]; do
                for i in / - \\ \|; do
                    sleep .1; echo -ne "\e[1D$i"
                done
            done
            tput cnorm
        }
        echo -ne "\033[1;33mLÃ¼tfen Bekleyin...\033[1;31m.\033[1;32m.\033[1;33m. \033[1;32m"
        helice
        echo -e "\e[1DTamam"
    }

    # --- FONKSÄ°YON: Yedek dosyasÄ±nÄ± web sunucusu dizinine kopyalar ---
    geralink () {
        if [ -d /var/www/html/backup ]; then
            rm -rf /var/www/html/backup/backup.vps > /dev/null 2>&1
            cp $HOME/backup.vps /var/www/html/backup/backup.vps
            sleep 2
        fi
    }

    # --- FONKSÄ°YON: Link oluÅŸtururken bekleme animasyonu gÃ¶sterir ---
    fun_temp2 () {
        helice () {
            geralink > /dev/null 2>&1 & 
            tput civis
            while [ -d /proc/$! ]; do
                for i in / - \\ \|; do
                    sleep .1; echo -ne "\e[1D$i"
                done
            done
            tput cnorm
        }
        echo -ne "\033[1;33mLÄ°NK OLUÅžTURULUYOR\033[1;31m.\033[1;32m.\033[1;33m. \033[1;32m"
        helice
        echo -e "\e[1DTamam"
    }
    
    # --- Ana MenÃ¼ ---
    echo -e "\E[44;1;37mðŸ‰ã…¤â™»ï¸ã…¤Yedekleme YÃ¶neticisiã…¤â™»ï¸ã…¤ðŸ‰\E[0m"
    echo ""
    echo -e "\033[1;31m[\033[1;36m1\033[1;31m] \033[1;37mâ€¢ \033[1;33mYEDEK OLUÅžTUR"
    echo -e "\033[1;31m[\033[1;36m2\033[1;31m] \033[1;37mâ€¢ \033[1;33mYEDEÄžÄ° GERÄ° YÃœKLE"
    echo -e "\033[1;31m[\033[1;36m3\033[1;31m] \033[1;37mâ€¢ \033[1;33mGERÄ° DÃ–N\033[1;37m"
    echo ""
    echo -ne "\033[1;32mNE YAPMAK Ä°STERSÄ°NÄ°Z\033[1;31m ?\033[1;37m : "; read opcao
    
    # --- SeÃ§enek 1: Yedek OluÅŸturma ---
    if [[ "$opcao" = '1' ]]; then
        # KullanÄ±cÄ± veritabanÄ± varsa devam et.
        if [ -f "/root/usuarios.db" ]; then
            rm -rf $HOME/backup.vps > /dev/null 2>&1
            sleep 1
            # Gerekli dosyalarÄ± bir .tar arÅŸivi iÃ§ine sÄ±kÄ±ÅŸtÄ±r.
            tar cvf /root/backup.vps /root/usuarios.db /etc/shadow /etc/passwd /etc/group /etc/gshadow /etc/VPSManager/senha > /dev/null 2>&1
            echo ""
            echo -e "\033[1;32mâ—‡ YEDEK BAÅžARIYLA OLUÅžTURULDU!\033[0m"
            echo ""
            echo -ne "\033[1;32mâ—‡ Ä°NDÄ°RME LÄ°NKÄ° ALMAK Ä°STER MÄ°SÄ°NÄ°Z \033[1;31m? \033[1;33m[e/h]:\033[1;37m "; read resp
            if [[ "$resp" = "e" ]]; then
                echo ""
                fun_temp # Apache'yi kur/ayarla
                echo ""
                fun_temp2 # Linki oluÅŸtur
                echo ""
                if [ -e /var/www/html/backup/backup.vps ]; then
                    echo -e "\033[1;32mâ—‡ LÄ°NK\033[1;37m: \033[1;36mhttp://$IP:8888/backup/backup.vps\033[0m"
                else
                    echo -e "\033[1;32mâ—‡ Konumunda mevcut:\033[1;31m" ~/"backup.vps\033[0m"
                fi
            else
                echo -e "\n\033[1;32mâ—‡ Konumunda mevcut:\033[1;31m" ~/"backup.vps\033[0m"
                sleep 2
            fi
        else
            # Yedeklenecek dosya yoksa...
            echo ""
            echo -e "\033[1;32mâ—‡ Yedek oluÅŸturuluyor...\033[0m"
            echo ""
            tar cvf /root/backup.vps /etc/shadow /etc/passwd /etc/group /etc/gshadow /etc/VPSManager/senha > /dev/null 2>&1
            sleep 2s
            echo ""
            echo -e "\033[1;33mâ—‡ \033[1;32mbackup.vps \033[1;33mdosyasÄ± ÅŸu dizinde baÅŸarÄ±yla oluÅŸturuldu: \033[1;31m/root\033[0m"
            echo ""
        fi
    fi
    
    # --- SeÃ§enek 2: Yedek Geri YÃ¼kleme ---
    if [[ "$opcao" = '2' ]]; then
        if [ -f "/root/backup.vps" ]; then
            echo ""
            echo -e "\033[1;36mâ—‡ Yedek geri yÃ¼kleniyor..."
            echo ""
            sleep 2s
            cp /root/backup.vps /backup.vps
            cd /
            tar -xvf backup.vps
            rm /backup.vps
            echo ""
            echo -e "\033[1;36mâ—‡ KullanÄ±cÄ±lar ve\033[1;36m ÅŸifreler baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±.\033[0m"
            echo ""
            exit
        else
            echo ""
            echo -e "\033[1;33mâ—‡ \033[1;32mbackup.vps \033[1;33mdosyasÄ± bulunamadÄ±!\033[0m"
            echo -e "\033[1;33mDosyanÄ±n /root/ dizininde \033[1;32mbackup.vps\033[1;33m adÄ±yla bulunduÄŸundan emin olun.\033[0m"
            echo ""
            exit
        fi
    fi
    
    # --- SeÃ§enek 3: Geri DÃ¶n ---
    if [[ "$opcao" = '3' ]]; then
        menu
    fi
    
} || {
    # --- ArgÃ¼man ile Ã‡alÄ±ÅŸtÄ±rma (Otomatik Yedekleme) ---
    # Bu bÃ¶lÃ¼m, betik 'userbackup 1' gibi bir argÃ¼manla Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda tetiklenir.
    # Muhtemelen Telegram botu veya zamanlanmÄ±ÅŸ gÃ¶rev (cron) tarafÄ±ndan kullanÄ±lÄ±r.
    rm /root/backup.vps 1>/dev/null 2>/dev/null
    tar cvf /root/backup.vps /root/usuarios.db /etc/shadow /etc/passwd /etc/group /etc/gshadow /etc/bot /etc/VPSManager/senha > /dev/null 2>&1
    [[ -d "/etc/VPSManager/backups" ]] && mv /root/backup.vps /etc/VPSManager/backups/backup.vps
    exit
}