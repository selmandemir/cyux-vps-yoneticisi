#!/bin/bash

clear

# --- FONKSÄ°YON: Arka planda bir komut Ã§alÄ±ÅŸÄ±rken "LÃ¼tfen Bekleyin" animasyonu gÃ¶sterir ---
fun_bar () {
    # Ã‡alÄ±ÅŸtÄ±rÄ±lacak komutlarÄ± bir diziye ata.
    comando[0]="$1"
    comando[1]="$2"
    
    # KomutlarÄ± arka planda Ã§alÄ±ÅŸtÄ±r. BittiÄŸinde 'fim' adÄ±nda bir dosya oluÅŸturur.
    (
        [[ -e $HOME/fim ]] && rm $HOME/fim
        ${comando[0]} > /dev/null 2>&1
        ${comando[1]} > /dev/null 2>&1
        touch $HOME/fim
    ) > /dev/null 2>&1 &
    
    # Ä°mleci gizle.
    tput civis
    echo -ne "   \033[1;33mLÃœTFEN BEKLEYÄ°N ... \033[1;37m- \033[1;33m["
    
    # 'fim' dosyasÄ± oluÅŸana kadar dÃ¶nen bir yÃ¼kleme Ã§ubuÄŸu animasyonu gÃ¶ster.
    while true; do
        for((i=0; i<18; i++)); do
            echo -ne "\033[1;31m#"
            sleep 0.1s
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -e "\033[1;33m]"
        sleep 1s
        tput cuu1 # Bir satÄ±r yukarÄ± Ã§Ä±k
        tput dl1  # SatÄ±rÄ± sil
        echo -ne "   \033[1;33mLÃœTFEN BEKLEYÄ°N ... \033[1;37m- \033[1;33m["
    done
    
    # Ä°ÅŸlem bittiÄŸinde onayla.
    echo -e "\033[1;33m]\033[1;37m -\033[1;32m TAMAM !\033[1;37m"
    # Ä°mleci tekrar gÃ¶rÃ¼nÃ¼r yap.
    tput cnorm
}

echo " "

# --- FONKSÄ°YON: GÃ¼ncel versiyon dosyasÄ±nÄ± GitHub'dan indirir ---
fun_atts () {
    # Eski versiyon dosyalarÄ±nÄ± temizle.
    [[ -e /home/versao ]] && rm /home/versao
    [[ -e /tmp/att ]] && rm /tmp/att
    
    # GitHub'dan en son versiyon dosyasÄ±nÄ± indir.
    wget -c -P /home https://raw.githubusercontent.com/selmandemir/cyux-vps-yoneticisi/main/Sistema/versao
    
    # Ä°ndirilen dosyayÄ± geÃ§ici bir konuma taÅŸÄ±.
    [[ -f "/home/versao" ]] && mv /home/versao /tmp/att
    
    # EÄŸer lokal versiyon dosyasÄ± yoksa, menÃ¼yÃ¼ de sil (yeniden kurulum iÃ§in).
    [[ ! -e /bin/versao ]] && rm -rf /bin/menu
} > /dev/null 2>&1

# ASCII SanatÄ± ile BaÅŸlÄ±k
echo -e "ã…¤ğŸ‰ã…¤Cyux VPS YÃ¶neticisiã…¤ğŸ‰ã…¤" | figlet
echo " "
echo -e "   \033[1;32mâ—‡ MEVCUT GÃœNCELLEMELER KONTROL EDÄ°LÄ°YOR\033[0m\n"

# Ä°ndirme iÅŸlemi sÄ±rasÄ±nda animasyon gÃ¶ster.
fun_bar 'fun_atts'

# Ä°ndirme baÅŸarÄ±sÄ±z olduysa hata ver.
[[ ! -f "/tmp/att" ]] && {
    echo -e "\n\033[1;31mâ—‡ SUNUCUYA BAÄLANIRKEN HATA OLUÅTU\n"
    echo -ne "\033[1;31mâ—‡ \033[1;32mMENÃœ'ye\033[1;33m dÃ¶nmek iÃ§in \033[1;31mENTER'a\033[0m basÄ±n."; read
    menu
}

echo " "

# Lokal versiyon ile sunucudaki versiyonu karÅŸÄ±laÅŸtÄ±r.
vrs1=$(sed -n '1 p' /bin/versao | sed -e 's/[^0-9]//ig')
vrs2=$(sed -n '1 p' /tmp/att | sed -e 's/[^0-9]//ig')

# EÄŸer versiyonlar aynÄ±ysa...
[[ "$vrs1" == "$vrs2" ]] && {
    echo -e " \033[1;36m   â—‡ SCRIPT'Ä°NÄ°Z ZATEN GÃœNCEL!\033[1;32m\n"
    rm /tmp/att > /dev/null 2>&1
    echo -ne " \033[1;31mâ—‡ \033[1;32mMENÃœ'ye\033[1;33m dÃ¶nmek iÃ§in \033[1;31mENTER'a\033[0m basÄ±n."; read
    menu
} || {
    # EÄŸer yeni bir versiyon varsa...
    echo -e "  \033[1;36mâ—‡ YENÄ° BÄ°R GÃœNCELLEME MEVCUT!\033[1;33m\n"
    echo -e "  \033[1;32mâ—‡ GÃœNCELLEME DETAYLARI:\033[0m\n"
    
    # GÃ¼ncelleme notlarÄ±nÄ± ekrana yazdÄ±r.
    while read linha; do
        echo -e "  \033[1;37m- \033[1;33m$linha"
    done < "/tmp/att"
    
    echo " "
    # KullanÄ±cÄ±ya gÃ¼ncelleme yapÄ±p yapmak istemediÄŸini sor.
    echo -ne "  \033[1;32mâ—‡ GÃœNCELLEMEK Ä°STER MÄ°SÄ°NÄ°Z \033[1;31m? \033[1;33m[e/h]:\033[1;37m "; read res
    
    if [[ "$res" = e || "$res" = E ]]; then
        echo -e "\n\033[1;32mâ—‡ GÃœNCELLEME BAÅLATILIYOR..."
        sleep 3
        
        # Ana kurulum script'ini indir ve Ã§alÄ±ÅŸtÄ±r.
        wget https://raw.githubusercontent.com/selmandemir/cyux-vps-yoneticisi/main/hehe > /dev/null 2>&1
        chmod +x hehe
        ./hehe
        clear
        
        echo -e "\033[1;32mâ—‡ SCRIPT BAÅARIYLA GÃœNCELLENDÄ°\033[0m\n"
        rm /tmp/att > /dev/null 2>&1
        echo -ne "\033[1;31mâ—‡ \033[1;32mMENÃœ'ye\033[1;33m dÃ¶nmek iÃ§in \033[1;31mENTER'a\033[0m basÄ±n."; read
        menu
    else
        # EÄŸer kullanÄ±cÄ± 'h' derse, menÃ¼ye dÃ¶n.
        menu
    fi
}