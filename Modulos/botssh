#!/bin/bash
clear

# --- FONKSÄ°YON: Arka planda bir komut Ã§alÄ±ÅŸÄ±rken "LÃ¼tfen Bekleyin" animasyonu gÃ¶sterir ---
fun_bar() {
    # Ã‡alÄ±ÅŸtÄ±rÄ±lacak komutlarÄ± bir diziye ata.
    comando[0]="$1"
    comando[1]="$2"
    
    # KomutlarÄ± arka planda Ã§alÄ±ÅŸtÄ±r. BittiÄŸinde 'fim' adÄ±nda bir dosya oluÅŸturur.
    (
        [[ -e $HOME/fim ]] && rm $HOME/fim
        ${comando[0]} -y >/dev/null 2>&1
        ${comando[1]} -y >/dev/null 2>&1
        touch $HOME/fim
    ) >/dev/null 2>&1 &
    
    # Ä°mleci gizle.
    tput civis
    echo -ne "\033[1;33m["
    
    # 'fim' dosyasÄ± oluÅŸana kadar dÃ¶nen bir yÃ¼kleme Ã§ubuÄŸu animasyonu gÃ¶ster.
    while true; do
        for ((i = 0; i < 18; i++)); do
            echo -ne "\033[1;31m#"
            sleep 0.1s
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -e "\033[1;33m]"
        sleep 1s
        tput cuu1 # Bir satÄ±r yukarÄ± Ã§Ä±k
        tput dl1  # SatÄ±rÄ± sil
        echo -ne "\033[1;33m["
    done
    
    # Ä°ÅŸlem bittiÄŸinde onayla ve imleci tekrar gÃ¶rÃ¼nÃ¼r yap.
    echo -e "\033[1;33m]\033[1;37m -\033[1;32m TAMAM !\033[1;37m"
    tput cnorm
}

# --- FONKSÄ°YON: Botu AÃ§ar veya KapatÄ±r ---
fun_botOnOff() {
    # 'bot_plus' adÄ±nda bir screen oturumunun Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± kontrol et.
    if [[ $(ps x | grep "bot_plus" | grep -v grep | wc -l) = '0' ]]; then
        # --- BOT AKTÄ°VASYON BÃ–LÃœMÃœ ---
        clear
        echo -e "\E[44;1;37m      ã…¤ğŸ‰ã…¤Cyux VPS YÃ¶neticisi Telegram Bot Kurulumuã…¤ğŸ‰ã…¤      \E[0m\n"
        echo -ne "\033[1;32mâ—‡ @BotFather'dan AldÄ±ÄŸÄ±nÄ±z Bot Token'Ä±nÄ± Girin:\033[1;37m "
        read tokenbot
        echo ""
        echo -ne "\033[1;32mâ—‡ Telegram ID'nizi Girin:\033[1;37m "
        read iduser
        clear
        echo -e "\033[1;32m      ã…¤ğŸ‰ã…¤Cyux VPS YÃ¶neticisi Telegram Botu BaÅŸlatÄ±lÄ±yor...ã…¤ğŸ‰ã…¤\033[0m\n"
        
        # Bot'u baÅŸlatan ve otomatik baÅŸlatmaya ekleyen alt fonksiyon.
        fun_bot1() {
            # Gerekli ShellBot.sh kÃ¼tÃ¼phanesini indir.
            wget -qO- https://raw.githubusercontent.com/selmandemir/cyux-vps-yoneticisi/main/Install/ShellBot.sh > /etc/VPSManager/ShellBot.sh
            
            cd /etc/VPSManager
            # Botu 'bot_plus' adÄ±yla yeni bir screen oturumunda baÅŸlat.
            screen -dmS bot_plus ./bot $tokenbot $iduser >/dev/null 2>&1
            
            # Bot'un sistem yeniden baÅŸladÄ±ÄŸÄ±nda otomatik Ã§alÄ±ÅŸmasÄ± iÃ§in /etc/autostart dosyasÄ±na ekle.
            if [[ $(grep -wc "bot_plus" /etc/autostart) = '0' ]]; then
                echo -e "ps x | grep 'bot_plus' | grep -v 'grep' || (cd /etc/VPSManager && sudo screen -dmS bot_plus ./bot $tokenbot $iduser && cd $HOME)" >>/etc/autostart
            else
                sed -i '/bot_plus/d' /etc/autostart
                echo -e "ps x | grep 'bot_plus' | grep -v 'grep' || (cd /etc/VPSManager && sudo screen -dmS bot_plus ./bot $tokenbot $iduser && cd $HOME)" >>/etc/autostart
            fi
            
            # Botun durumunu kontrol eden bir gÃ¶revi crontab'a ekle.
            [[ $(crontab -l | grep -c "verifbot") = '0' ]] && (crontab -l 2>/dev/null; echo "@daily /bin/verifbot") | crontab -
            cd $HOME
        }
        
        fun_bar 'fun_bot1' # Ä°ÅŸlem sÄ±rasÄ±nda animasyon gÃ¶ster.
        
        # Bot'un Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± kontrol et ve sonuÃ§ mesajÄ±nÄ± gÃ¶ster.
        [[ $(ps x | grep "bot_plus" | grep -v grep | wc -l) != '0' ]] && echo -e "\n\033[1;32mğŸ‰ã…¤Cyux VPS YÃ¶neticisi Telegram Botu Aktif Edildi!ã…¤ğŸ‰\033[0m" || echo -e "\n\033[1;31mâ—‡ HATA! GÄ°RDÄ°ÄÄ°NÄ°Z BÄ°LGÄ°LERÄ° KONTROL EDÄ°N\033[0m"
        sleep 2
        menu
    else
        # --- BOT DEVRE DIÅI BIRAKMA BÃ–LÃœMÃœ ---
        clear
        echo -e "\033[1;32mğŸ‰ã…¤Cyux VPS YÃ¶neticisi Telegram Botu Durduruluyor...ã…¤ğŸ‰\033[0m\n"
        
        # Bot'u durduran ve otomatik baÅŸlatmadan kaldÄ±ran alt fonksiyon.
        fun_bot2() {
            screen -r -S "bot_plus" -X quit # Screen oturumunu sonlandÄ±r.
            screen -wipe 1>/dev/null 2>/dev/null
            sed -i '/bot_plus/d' /etc/autostart # Otomatik baÅŸlatma dosyasÄ±ndan sil.
            crontab -l | grep -v 'verifbot' | crontab - # Crontab gÃ¶revini kaldÄ±r.
            sleep 1
        }
        
        fun_bar 'fun_bot2' # Ä°ÅŸlem sÄ±rasÄ±nda animasyon gÃ¶ster.
        echo -e "\n\033[1;32m \033[1;31mğŸ‰ã…¤Cyux VPS YÃ¶neticisi Telegram Botu Durduruldu!ã…¤ğŸ‰\033[0m"
        sleep 2
        menu
    fi
}

# --- FONKSÄ°YON: Ä°lk kurulum iÃ§in talimatlarÄ± gÃ¶sterir ---
fun_instbot() {
    echo -e "\E[44;1;37m      ã…¤ğŸ‰ã…¤Cyux VPS YÃ¶neticisi Telegram Bot Kurulumuã…¤ğŸ‰ã…¤      \E[0m\n"
    echo -e "               \033[1;33m[\033[1;31m!\033[1;33m] \033[1;31mDÄ°KKAT! \033[1;33m[\033[1;31m!\033[1;33m]\033[0m"
    echo -e "\n\033[1;32m1Â° \033[1;37m- \033[1;33mTelegram hesabÄ±nÄ±z Ã¼zerinden aÅŸaÄŸÄ±daki botlara eriÅŸin\033[1;37m:\033[0m"
    echo -e "\n\033[1;32m2Â° \033[1;37m- \033[1;33mBOT \033[1;37m@BotFather \033[1;33mÄ°LE BOTUNUZU OLUÅTURUN. \033[1;31m@BotFather'a ÅŸunu gÃ¶nderin: \033[1;37m/newbot\033[0m"
    echo -e "\n\033[1;32m3Â° \033[1;37m- \033[1;33mBOT \033[1;37m@TwincyBot \033[1;33mÄ°LE ID'NÄ°ZÄ° ALIN. \033[1;31m@TwincyBot'a ÅŸunu gÃ¶nderin: \033[1;37m/id\033[0m"
    echo -e "\033[0;34mâ—‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‡\033[1;32m"
    echo ""
    read -p "â—‡ DEVAM ETMEK Ä°STER MÄ°SÄ°NÄ°Z ? [e/h]: " -e -i e resposta
    if [[ "$resposta" = 'e' ]]; then
        fun_botOnOff
    else
        echo -e "\n\033[1;31mâ—‡ Geri dÃ¶nÃ¼lÃ¼yor...\033[0m"
        sleep 2
        menu
    fi
}

# --- ANA MANTIK ---
# EÄŸer ShellBot kÃ¼tÃ¼phanesi zaten kuruluysa, direkt aÃ§/kapa menÃ¼sÃ¼nÃ¼ gÃ¶ster.
# Kurulu deÄŸilse, ilk kurulum talimatlarÄ±nÄ± gÃ¶ster.
[[ -f "/etc/VPSManager/ShellBot.sh" ]] && fun_botOnOff || fun_instbot