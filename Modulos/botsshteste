#!/bin/bash
clear
# Gerekli ShellBot kÃ¼tÃ¼phanesini dahil et.
source ShellBot.sh
# Daha Ã¶nce test hesabÄ± alan kullanÄ±cÄ±larÄ±n ID'lerini tutmak iÃ§in bir liste dosyasÄ± oluÅŸtur.
touch lista

# 5 gÃ¼nde bir test listesini sÄ±fÄ±rlamak iÃ§in bir kontrol dosyasÄ± oluÅŸtur.
[[ ! -e RESET ]] && touch RESET

# Script'e verilen argÃ¼manlarÄ± (bot token'Ä± ve admin ID'si) al.
api_bot=$1
ShellBot.init --token "$api_bot" --monitor --flush
ShellBot.username

# --- FONKSÄ°YON: Ana menÃ¼yÃ¼ gÃ¶sterir ---
menu() {
    local msg
    msg="â—‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‡\n"
    msg+="<b>â€¢ğŸ”¹â€¢ MERHABA, HOÅ GELDÄ°NÄ°Z â€¢ğŸ”¹â€¢</b>\n"
    msg+="â—‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‡\n\n"
    msg+="SSH HesabÄ± 10 TL/Ay" # Fiyat bilgisini dÃ¼zenleyebilirsiniz.
    ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
        --text "$(echo -e $msg)" \
        --reply_markup "$keyboard1" \
        --parse_mode html
    return 0
}

# --- FONKSÄ°YON: 1 saatlik test SSH hesabÄ± oluÅŸturur ---
criarteste() {
    # KullanÄ±cÄ±nÄ±n daha Ã¶nce test hesabÄ± alÄ±p almadÄ±ÄŸÄ±nÄ± kontrol et.
    [[ $(grep -wc ${callback_query_from_id} lista) != '0' ]] && {
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id} \
            --text "ZATEN BÄ°R TEST HESABI OLUÅTURDUNUZ!"
        return 0
    }
    
    # Rastgele bir kullanÄ±cÄ± adÄ± ve ÅŸifre oluÅŸtur.
    usuario=$(echo TEST$(( RANDOM% + 250 )))
    senha=$((RANDOM% + 99999))
    limite='1'
    tempo='1' # GeÃ§erlilik sÃ¼resi (saat)
    
    # Son kullanma tarihini hesapla.
    tuserdate=$(date '+%C%y/%m/%d' -d " +1 days")
    
    # KullanÄ±cÄ±yÄ± oluÅŸtur, ÅŸifresini ayarla ve veritabanlarÄ±na kaydet.
    useradd -M -N -s /bin/false $usuario -e $tuserdate > /dev/null 2>&1
    (echo "$senha";echo "$senha") | passwd $usuario > /dev/null 2>&1
    echo "$senha" > /etc/VPSManager/senha/$usuario
    echo "$usuario $limite" >> /root/usuarios.db
    
    # Belirtilen sÃ¼re sonunda kullanÄ±cÄ±yÄ± otomatik olarak silecek bir script oluÅŸtur.
    echo "#!/bin/bash
pkill -f \"$usuario\"
userdel --force $usuario
grep -v ^$usuario[[:space:]] /root/usuarios.db > /tmp/ph ; cat /tmp/ph > /root/usuarios.db
rm /etc/VPSManager/senha/$usuario > /dev/null 2>&1
rm -rf /etc/VPSManager/userteste/$usuario.sh" > /etc/VPSManager/userteste/$usuario.sh
    chmod +x /etc/VPSManager/userteste/$usuario.sh
    
    # Otomatik silme script'ini 'at' komutuyla zamanla.
    at -f /etc/VPSManager/userteste/$usuario.sh now + $tempo hour > /dev/null 2>&1
    
    # KullanÄ±cÄ±nÄ±n ID'sini listeye ekle.
    echo ${callback_query_from_id} >> lista
    
    # KullanÄ±cÄ± bilgilerini Telegram'a gÃ¶nder.
    ShellBot.sendMessage --chat_id ${callback_query_message_chat_id} \
        --text "$(echo -e "âœ… <b>Hesap baÅŸarÄ±yla oluÅŸturuldu</b> âœ…\n\nSUNUCU: $(cat /etc/IP) \n\nKULLANICI ADI: <code>$usuario</code>\nÅÄ°FRE: <code>$senha</code>\n\nâ³ Kalan SÃ¼re: $tempo Saat")" \
        --parse_mode html
    return 0
}

# --- FONKSÄ°YON: KullanÄ±cÄ±nÄ±n Telegram bilgilerini gÃ¶sterir ---
infouser () {
    ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
        --text "$(echo -e "Ä°sim:  ${message_from_first_name[$(ShellBot.ListUpdates)]}\nKullanÄ±cÄ±: @${message_from_username[$(ShellBot.ListUpdates)]:-null}")\nID: ${message_from_id[$(ShellBot.ListUpdates)]} " \
        --parse_mode html
    return 0
}

# --- FONKSÄ°YON: Ã–deme bilgilerini gÃ¶sterir ---
pix () {
    ShellBot.sendMessage --chat_id ${callback_query_message_chat_id} \
        --text "$(echo -e "<b>SSH HesabÄ± 10 TL/Ay \n\nÃ–DEME Ä°Ã‡Ä°N YÃ–NETÄ°CÄ° Ä°LE Ä°LETÄ°ÅÄ°ME GEÃ‡Ä°N.</b>")" \
        --parse_mode html
    return 0
}

# --- DÃ¼ÄŸme TanÄ±mlamalarÄ± ---
unset botao1; botao1=''
ShellBot.InlineKeyboardButton --button 'botao1' --line 1 --text 'TEST HESABI OLUÅTUR' --callback_data 'gerarssh'
ShellBot.InlineKeyboardButton --button 'botao1' --line 2 --text 'TELEGRAM DESTEK' --callback_data '2' --url 'https://t.me/SD_VPS_MANAGER'
ShellBot.InlineKeyboardButton --button 'botao1' --line 3 --text 'SATIN AL' --callback_data 'pay'

# FonksiyonlarÄ± dÃ¼ÄŸme verilerine ata.
ShellBot.regHandleFunction --function criarteste --callback_data gerarssh
ShellBot.regHandleFunction --function pix --callback_data pay

# DÃ¼ÄŸmeleri bir klavye dÃ¼zenine yerleÅŸtir.
unset keyboard1; keyboard1="$(ShellBot.InlineKeyboardMarkup -b 'botao1')"

# --- Ana Bot DÃ¶ngÃ¼sÃ¼ ---
while :; do
    # Her 5 gÃ¼nde bir test kullanÄ±cÄ± listesini sÄ±fÄ±rla.
    [[ "$(date +%d)" != "$(cat RESET)" ]] && {
        echo $(date +%d) > RESET
        echo ' ' > lista
    }
    
    # Telegram'dan gelen gÃ¼ncellemeleri dinle.
    ShellBot.getUpdates --limit 100 --offset $(ShellBot.OffsetNext) --timeout 30
    for id in $(ShellBot.ListUpdates); do
        (
            # Bir dÃ¼ÄŸmeye tÄ±klandÄ±ysa, ilgili fonksiyonu Ã§alÄ±ÅŸtÄ±r.
            ShellBot.watchHandle --callback_data ${callback_query_data[$id]}
            
            # Gelen mesaj bir komut ise, ilgili fonksiyonu Ã§alÄ±ÅŸtÄ±r.
            comando=(${message_text[$id]})
            [[ "${comando[0]}" = "/menu"  || "${comando[0]}" = "/start" ]] && menu
            [[ "${comando[0]}" = "/id"    ]] && infouser
        ) &
    done
done