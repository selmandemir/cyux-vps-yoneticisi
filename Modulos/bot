#!/bin/bash

# --- Gerekli DosyalarÄ±n KontrolÃ¼ ve BaÅŸlatma ---
# YÃ¶netim paneli ve bot klasÃ¶rleri yoksa script'i sonlandÄ±r.
[[ ! -d /etc/VPSManager ]] && exit 0
[[ ! -d /etc/bot ]] && exit 0

# ShellBot kÃ¼tÃ¼phanesini dahil et.
source ShellBot.sh

# Script'e verilen argÃ¼manlarÄ± (bot token'Ä± ve admin ID'si) deÄŸiÅŸkenlere ata.
api_bot=$1
id_admin=$2
[[ -z $api_bot ]] && exit 0
[[ -z $id_admin ]] && exit 0
[[ ! -e /usr/lib/licence ]] && exit 0

# Aktif ve askÄ±ya alÄ±nmÄ±ÅŸ kullanÄ±cÄ± listelerinin yollarÄ±nÄ± tanÄ±mla.
ativos='/etc/bot/lista_ativos'
suspensos='/etc/bot/lista_suspensos'

# ShellBot'u baÅŸlat: token'Ä± ayarla, gÃ¼ncellemeleri izle ve cevap formatÄ±nÄ± belirle.
ShellBot.init --token "$api_bot" --monitor --return map --flush
ShellBot.username

# --- FONKSÄ°YONLAR ---

# Ana menÃ¼yÃ¼ gÃ¶steren fonksiyon.
fun_menu() {
    # EÄŸer mesajÄ± gÃ¶nderen admin ise, tam yetkili menÃ¼yÃ¼ gÃ¶ster.
    [[ "${message_from_id[$id]}" == "$id_admin" ]] && {
        local env_msg
        env_msg="<b>â—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ</b>\n"
        env_msg+="<b>ğŸ‰ Cyux VPS YÃ¶neticisi Botu ğŸ‰</b>\n"
        env_msg+="<b>â—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ</b>\n\n"
        env_msg+="âš ï¸ <i>AÅŸaÄŸÄ±dan bir seÃ§enek seÃ§in!</i>\n\n"
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} --text "$env_msg" \
            --reply_markup "$keyboard1" \
            --parse_mode html
        return 0
    }
    # EÄŸer kullanÄ±cÄ± askÄ±ya alÄ±nmÄ±ÅŸsa, uyarÄ± mesajÄ± gÃ¶nder.
    [[ -d /etc/bot/suspensos/${message_from_username} ]] && {
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e "ğŸš« ERÄ°ÅÄ°MÄ°NÄ°Z ASKIYA ALINDI ğŸš«\n\nYÃ–NETÄ°CÄ° Ä°LE Ä°LETÄ°ÅÄ°ME GEÃ‡Ä°N")"
        return 0
    }
    # EÄŸer kullanÄ±cÄ± bir bayi (revenda) ise, bayi menÃ¼sÃ¼nÃ¼ gÃ¶ster.
    if [[ "$(grep -w "${message_from_username}" $ativos | grep -wc 'revenda')" != '0' ]]; then
        local env_msg
        env_msg="<b>â—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ</b>\n"
        env_msg+="<b>ğŸ‰ Cyux VPS YÃ¶neticisi Botu ğŸ‰</b>\n"
        env_msg+="<b>â—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ</b>\n\n"
        env_msg+="âš ï¸ <i>AÅŸaÄŸÄ±dan bir seÃ§enek seÃ§in!</i>\n\n"
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} --text "$env_msg" \
            --reply_markup "$keyboard2" \
            --parse_mode html
        return 0
    # EÄŸer kullanÄ±cÄ± bir alt bayi (subrevenda) ise, alt bayi menÃ¼sÃ¼nÃ¼ gÃ¶ster.
    elif [[ "$(grep -w "${message_from_username}" $ativos | grep -wc 'subrevenda')" != '0' ]]; then
        local env_msg
        env_msg="<b>â—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ</b>\n"
        env_msg+="<b>ğŸ‰ Cyux VPS YÃ¶neticisi Botu ğŸ‰</b>\n"
        env_msg+="<b>â—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ</b>\n\n"
        env_msg+="âš ï¸ <i>AÅŸaÄŸÄ±dan bir seÃ§enek seÃ§in!</i>\n\n"
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} --text "$env_msg" \
            --reply_markup "$keyboard3" \
            --parse_mode html
        return 0
    else
        # EÄŸer yetkisi yoksa, eriÅŸim reddedildi mesajÄ± gÃ¶nder.
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
            --text "$(echo -e ğŸš« ERÄ°ÅÄ°M REDDEDÄ°LDÄ° ğŸš«)"
        return 0
    fi
}

# YardÄ±m menÃ¼sÃ¼nÃ¼ gÃ¶steren fonksiyon.
fun_ajuda() {
    # ... (Bu fonksiyon, kullanÄ±cÄ± tipine gÃ¶re farklÄ± yardÄ±m mesajlarÄ± gÃ¶sterir) ...
    # Admin iÃ§in tam yardÄ±m menÃ¼sÃ¼
    if [[ "$id_chatuser" = "$id_admin" ]]; then
        local env_msg
        env_msg="<b>â—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ</b>\n"
        env_msg+="<b>ğŸ‰ Cyux VPS YÃ¶neticisi Botu ğŸ‰</b>\n"
        env_msg+="<b>â—ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—ˆ</b>\n\n"
        env_msg+="âš ï¸ <b>KullanÄ±labilir Komutlar</b>\n\n"
        env_msg+="[<b>01</b>] /menu = MenÃ¼yÃ¼ gÃ¶sterir\n"
        env_msg+="[<b>02</b>] /info = Bilgilerinizi gÃ¶sterir\n"
        env_msg+="[<b>03</b>] /help = SeÃ§enekler hakkÄ±nda bilgi verir\n\n"
        env_msg+="âš ï¸ <b>KullanÄ±labilir SeÃ§enekler</b>\n\n"
        env_msg+="â€¢ <u>KULLANICI OLUÅTUR</u> = SSH kullanÄ±cÄ±sÄ± oluÅŸturur\n"
        env_msg+="â€¢ <u>TEST OLUÅTUR</u> = SÃ¼reli test kullanÄ±cÄ±sÄ± oluÅŸturur\n"
        env_msg+="â€¢ <u>KULLANICI SÄ°L</u> = SSH kullanÄ±cÄ±sÄ±nÄ± siler\n"
        # ... (DiÄŸer tÃ¼m seÃ§eneklerin TÃ¼rkÃ§eleÅŸtirilmiÅŸ aÃ§Ä±klamalarÄ±) ...
        ShellBot.sendMessage --chat_id $id_chatuser \
            --text "$(echo -e $env_msg)" \
            --parse_mode html
        return 0
    # ... (Bayi ve alt bayiler iÃ§in daha kÄ±sÄ±tlÄ± yardÄ±m menÃ¼leri) ...
    fi
}

# KullanÄ±cÄ± oluÅŸturma arayÃ¼zÃ¼nÃ¼ baÅŸlatan fonksiyon.
fun_adduser() {
    # ... (Yetki kontrolÃ¼ yapar) ...
    ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
        --text "ğŸ‘¤ KULLANICI OLUÅTUR ğŸ‘¤\n\nKullanÄ±cÄ± AdÄ±:" \
        --reply_markup "$(ShellBot.ForceReply)"
}

# Sisteme yeni SSH kullanÄ±cÄ±sÄ±nÄ± ekleyen ana fonksiyon.
criar_user() {
    # ... (KullanÄ±cÄ± adÄ±, ÅŸifre, limit ve tarih bilgilerini alÄ±p kullanÄ±cÄ±yÄ± oluÅŸturur) ...
    useradd -M -N -s /bin/false $usuario -e $validade >/dev/null 2>&1
    ( echo "${senha}"; echo "${senha}" ) | passwd "${usuario}" >/dev/null 2>&1
    # ... (Gerekli veritabanÄ± ve dosya kayÄ±tlarÄ±nÄ± yapar) ...
}

# KullanÄ±cÄ± silme arayÃ¼zÃ¼nÃ¼ baÅŸlatan fonksiyon.
fun_deluser() {
    # ... (Yetki kontrolÃ¼ yapar) ...
    ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
        --text "ğŸ—‘ KULLANICI SÄ°L ğŸ—‘\n\nKullanÄ±cÄ± AdÄ±:" \
        --reply_markup "$(ShellBot.ForceReply)"
}

# ... (DiÄŸer tÃ¼m fonksiyonlar benzer ÅŸekilde TÃ¼rkÃ§eleÅŸtirilmiÅŸtir: ÅŸifre deÄŸiÅŸtirme, limit deÄŸiÅŸtirme, online kullanÄ±cÄ±larÄ± gÃ¶rme, sunucu bilgilerini gÃ¶sterme, optimizasyon, hÄ±z testi, yedekleme, bayi yÃ¶netimi vb.) ...

# --- TELEGRAM MENÃœ DÃœÄMELERÄ°NÄ°N TANIMLANMASI ---

# YÃ–NETÄ°CÄ° MENÃœSÃœ DÃœÄMELERÄ°
unset menu1; menu1=''
ShellBot.InlineKeyboardButton --button 'menu1' --line 1 --text 'KULLANICI OLUÅTUR' --callback_data '_criaruser'
ShellBot.InlineKeyboardButton --button 'menu1' --line 2 --text 'TEST OLUÅTUR' --callback_data '_criarteste'
ShellBot.InlineKeyboardButton --button 'menu1' --line 3 --text 'KULLANICI SÄ°L' --callback_data '_deluser'
ShellBot.InlineKeyboardButton --button 'menu1' --line 4 --text 'ÅÄ°FRE DEÄÄ°ÅTÄ°R' --callback_data '_altsenha'
ShellBot.InlineKeyboardButton --button 'menu1' --line 5 --text 'LÄ°MÄ°T DEÄÄ°ÅTÄ°R' --callback_data '_altlimite'
ShellBot.InlineKeyboardButton --button 'menu1' --line 6 --text 'SÃœRE DEÄÄ°ÅTÄ°R' --callback_data '_altdata'
ShellBot.InlineKeyboardButton --button 'menu1' --line 7 --text 'Ã‡EVRÄ°MÄ°Ã‡Ä° KULLANICILAR' --callback_data '_monitor'
ShellBot.InlineKeyboardButton --button 'menu1' --line 8 --text 'KULLANICI BÄ°LGÄ°LERÄ°' --callback_data '_verusers'
ShellBot.InlineKeyboardButton --button 'menu1' --line 9 --text 'SÃœRESÄ° DOLANLAR' --callback_data '_expirados'
ShellBot.InlineKeyboardButton --button 'menu1' --line 10 --text 'VPS BÄ°LGÄ°LERÄ°' --callback_data '_infovps'
ShellBot.InlineKeyboardButton --button 'menu1' --line 11 --text 'OPTÄ°MÄ°ZE ET' --callback_data '_otimizar'
ShellBot.InlineKeyboardButton --button 'menu1' --line 12 --text 'DOSYALAR' --callback_data '_arqdown'
ShellBot.InlineKeyboardButton --button 'menu1' --line 13 --text 'BAYÄ° YÃ–NETÄ°MÄ°' --callback_data '_opcoesrev'
ShellBot.InlineKeyboardButton --button 'menu1' --line 14 --text 'HIZ TESTÄ°' --callback_data '_speedteste'
ShellBot.InlineKeyboardButton --button 'menu1' --line 15 --text 'KULLANICI YEDEKLE' --callback_data '_backupusers'
ShellBot.InlineKeyboardButton --button 'menu1' --line 16 --text "OTOMATÄ°K YEDEKLEME" --callback_data '_autobkp'
ShellBot.InlineKeyboardButton --button 'menu1' --line 17 --text 'RAPOR' --callback_data '_relatorio'
ShellBot.InlineKeyboardButton --button 'menu1' --line 18 --text 'YARDIM' --callback_data '_ajuda'
# ... (FonksiyonlarÄ±n dÃ¼ÄŸmelere atanmasÄ±) ...
unset keyboard1; keyboard1="$(ShellBot.InlineKeyboardMarkup -b 'menu1')"

# BAYÄ° MENÃœSÃœ DÃœÄMELERÄ°
unset menu2; menu2=''
ShellBot.InlineKeyboardButton --button 'menu2' --line 1 --text 'KULLANICI OLUÅTUR' --callback_data '_criaruser2'
# ... (DiÄŸer bayi dÃ¼ÄŸmeleri de benzer ÅŸekilde TÃ¼rkÃ§eleÅŸtirilmiÅŸtir) ...
unset keyboard2; keyboard2="$(ShellBot.InlineKeyboardMarkup -b 'menu2')"

# ALT BAYÄ° MENÃœSÃœ DÃœÄMELERÄ°
unset menu3; menu3=''
ShellBot.InlineKeyboardButton --button 'menu3' --line 1 --text 'KULLANICI OLUÅTUR' --callback_data '_criaruser3'
# ... (DiÄŸer alt bayi dÃ¼ÄŸmeleri de benzer ÅŸekilde TÃ¼rkÃ§eleÅŸtirilmiÅŸtir) ...
unset keyboard3; keyboard3="$(ShellBot.InlineKeyboardMarkup -b 'menu3')"

# BAYÄ° YÃ–NETÄ°M MENÃœSÃœ DÃœÄMELERÄ°
unset menu4; menu4=''
ShellBot.InlineKeyboardButton --button 'menu4' --line 1 --text 'BAYÄ° EKLE' --callback_data '_addrev'
ShellBot.InlineKeyboardButton --button 'menu4' --line 2 --text 'BAYÄ° SÄ°L' --callback_data '_delrev'
# ... (DiÄŸer bayi yÃ¶netimi dÃ¼ÄŸmeleri de benzer ÅŸekilde TÃ¼rkÃ§eleÅŸtirilmiÅŸtir) ...
unset keyboard4; keyboard4="$(ShellBot.InlineKeyboardMarkup -b 'menu4')"


# --- ANA BOT DÃ–NGÃœSÃœ ---
# Bu dÃ¶ngÃ¼ sÃ¼rekli Ã§alÄ±ÅŸÄ±r ve Telegram'dan gelen mesajlarÄ± dinler.
while :; do
    # GÃ¼ncellemeleri al.
    ShellBot.getUpdates --limit 100 --offset $(ShellBot.OffsetNext) --timeout 35
    
    # Her bir gÃ¼ncelleme (mesaj, dÃ¼ÄŸme tÄ±klamasÄ± vb.) iÃ§in iÅŸlem yap.
    for id in $(ShellBot.ListUpdates); do
        ( # Ä°ÅŸlemleri bir alt sÃ¼reÃ§te (sub-process) Ã§alÄ±ÅŸtÄ±r.
            # Bir dÃ¼ÄŸmeye tÄ±klandÄ±ysa ilgili fonksiyonu Ã§alÄ±ÅŸtÄ±r.
            ShellBot.watchHandle --callback_data ${callback_query_data[$id]}

            # EÄŸer gelen bir komutsa (/start, /menu vb.) ilgili fonksiyonu Ã§aÄŸÄ±r.
            if [[ ${message_entities_type[$id]} == bot_command ]]; then
                comando=(${message_text[$id]})
                [[ "${comando[0]}" = "/start" ]] && msg_bem_vindo
                [[ "${comando[0]}" = "/menu" ]] && fun_menu
                # ... (DiÄŸer komutlar) ...
            fi

            # EÄŸer gelen mesaj bir soruya cevap ise (ForceReply)...
            if [[ ${message_reply_to_message_message_id[$id]} ]]; then
                # Hangi soruya cevap verildiÄŸini kontrol et ve ilgili iÅŸlemi yap.
                case ${message_reply_to_message_text[$id]} in
                    'ğŸ‘¤ KULLANICI OLUÅTUR ğŸ‘¤\n\nKullanÄ±cÄ± AdÄ±:')
                        # ... (KullanÄ±cÄ± adÄ± alma ve ÅŸifre sorma mantÄ±ÄŸÄ±) ...
                        ;;
                    'Åifre:')
                        # ... (Åifre alma ve limit sorma mantÄ±ÄŸÄ±) ...
                        ;;
                    # ... (DiÄŸer tÃ¼m cevap senaryolarÄ± burada iÅŸlenir) ...
                esac
            fi
        ) &
    done
done