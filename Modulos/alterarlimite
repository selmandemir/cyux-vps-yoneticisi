#!/bin/bash
# BaÅŸlÄ±k metnini mavi arka plan Ã¼zerine beyaz ve kalÄ±n olarak yazdÄ±r.
tput setaf 7 ; tput setab 4 ; tput bold ; printf '%20s%s\n' "ã…¤ğŸ‰ã…¤EÅŸ ZamanlÄ± BaÄŸlantÄ± Limitini DeÄŸiÅŸtirmeã…¤ğŸ‰ã…¤" ; tput sgr0

# KullanÄ±cÄ± limitlerinin saklandÄ±ÄŸÄ± veritabanÄ± dosyasÄ±nÄ±n yolu.
database="/root/usuarios.db"

# VeritabanÄ± dosyasÄ± yoksa hata ver ve Ã§Ä±k.
if [ ! -f "$database" ]; then
    tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "$database DosyasÄ± bulunamadÄ±!" ; echo "" ; tput sgr0
    exit 1
else
    # EÄŸer dosya varsa, kullanÄ±cÄ±larÄ±n listesini ve mevcut limitlerini gÃ¶ster.
    tput setaf 3 ; tput bold ; echo ""; echo "â—‡ KULLANICI LÄ°STESÄ° VE LÄ°MÄ°TLERÄ°:" ; tput sgr0
    echo ""
    
    # Sistemdeki normal kullanÄ±cÄ±larÄ± (/etc/passwd dosyasÄ±ndan) listele.
    _userT=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody)
    i=0
    unset _userPass
    
    # Her bir kullanÄ±cÄ± iÃ§in bir dÃ¶ngÃ¼ baÅŸlat.
    while read _user; do
        i=$(expr $i + 1)
        _oP=$i
        [[ $i == [1-9] ]] && i=0$i && oP+=" 0$i"
        
        # KullanÄ±cÄ±nÄ±n limiti veritabanÄ± dosyasÄ±nda kayÄ±tlÄ± mÄ± diye kontrol et.
        if [[ "$(grep -wc "$_user" $database)" != "0" ]]; then
            # KayÄ±tlÄ±ysa, limiti dosyadan oku.
            limit=$(grep -w "$_user" $database | cut -d' ' -f2)
        else
            # KayÄ±tlÄ± deÄŸilse, varsayÄ±lan olarak limiti '1' kabul et.
            limit='1'
        fi
        
        # KullanÄ±cÄ± adÄ±nÄ± ve limitini formatlÄ± bir ÅŸekilde ekrana yazdÄ±r.
        l_user=$(echo -e "\033[1;31m[\033[1;36m$i\033[1;31m] \033[1;37m- \033[1;32m$_user\033[0m")
        lim=$(echo -e "\033[1;33mâ—‡ã…¤Limit\033[1;37m: $limit")
        printf '%-65s%s\n' "$l_user" "$lim"
        
        # Daha sonra kolay seÃ§im iÃ§in kullanÄ±cÄ± listesini bir deÄŸiÅŸkende biriktir.
        _userPass+="\n${_oP}:${_user}"
    done <<< "${_userT}"
    
    echo ""
    # Sistemdeki toplam kullanÄ±cÄ± sayÄ±sÄ±nÄ± bul.
    num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
    
    # KullanÄ±cÄ±dan bir seÃ§im yapmasÄ±nÄ± iste.
    echo -ne "\033[1;32mâ—‡ Bir kullanÄ±cÄ± girin veya seÃ§in \033[1;33m[\033[1;36m1\033[1;31m-\033[1;36m$num_user\033[1;33m]\033[1;37m: " ; read option
    
    # SeÃ§ilen numaraya karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ±nÄ± bul.
    usuario=$(echo -e "${_userPass}" | grep -E "\b$option\b" | cut -d: -f2)
    
    # EÄŸer giriÅŸ boÅŸ veya geÃ§ersizse hata ver.
    if [[ -z $option ]]; then
        tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "â—‡ BoÅŸ veya geÃ§ersiz kullanÄ±cÄ± girdiniz." ; echo "" ; tput sgr0
        exit
    elif [[ -z $usuario ]]; then
        tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "â—‡ BoÅŸ veya geÃ§ersiz kullanÄ±cÄ± girdiniz." ; echo "" ; tput sgr0
        exit 1
    else
        # SeÃ§ilen kullanÄ±cÄ± sistemde gerÃ§ekten var mÄ± diye kontrol et.
        if cat /etc/passwd |grep -w $usuario > /dev/null; then
            # KullanÄ±cÄ±dan yeni limiti girmesini iste.
            echo -ne "\n\033[1;32mâ—‡ \033[1;33m$usuario\033[1;32m kullanÄ±cÄ±sÄ± iÃ§in yeni limit\033[1;37m: "; read sshnum
            
            # Girilen limitin geÃ§erliliÄŸini kontrol et (boÅŸ olamaz, sayÄ± olmalÄ±, sÄ±fÄ±rdan bÃ¼yÃ¼k olmalÄ±).
            if [[ -z $sshnum ]]; then
                tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "â—‡ GeÃ§ersiz bir sayÄ± girdiniz!" ; echo "" ; tput sgr0
                exit 1
            else
                if (echo $sshnum | egrep [^0-9] &> /dev/null); then
                    tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "â—‡ GeÃ§ersiz bir sayÄ± girdiniz!" ; echo "" ; tput sgr0
                    exit 1
                else
                    if [[ $sshnum -lt 1 ]]; then
                        tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "â—‡ SÄ±fÄ±rdan bÃ¼yÃ¼k bir sayÄ± girmelisiniz!" ; echo "" ; tput sgr0
                        exit 1
                    else
                        # VeritabanÄ± dosyasÄ±ndan kullanÄ±cÄ±nÄ±n eski kaydÄ±nÄ± sil.
                        grep -v "^$usuario[[:space:]]" /root/usuarios.db > /tmp/a
                        sleep 1
                        mv /tmp/a /root/usuarios.db
                        
                        # KullanÄ±cÄ±nÄ±n yeni limitini dosyaya ekle.
                        echo "$usuario $sshnum" >> /root/usuarios.db
                        
                        tput setaf 7 ; tput setab 4 ; tput bold ; echo "" ; echo "â—‡ $usuario kullanÄ±cÄ±sÄ±na $sshnum limiti baÅŸarÄ±yla uygulandÄ±." ; tput sgr0
                        sleep 2
                        exit
                    fi
                fi
            fi      
        else
            # EÄŸer kullanÄ±cÄ± sistemde bulunamazsa hata ver.
            tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "â—‡ $usuario kullanÄ±cÄ±sÄ± bulunamadÄ±." ; echo "" ; tput sgr0
            exit 1
        fi
    fi
fi