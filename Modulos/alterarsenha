#!/bin/bash
# BaÅŸlÄ±k metnini mavi arka plan Ã¼zerine beyaz ve kalÄ±n olarak yazdÄ±r.
tput setaf 7 ; tput setab 4 ; tput bold ; printf '%35s%s%-10s\n' "ğŸ‰ã…¤KullanÄ±cÄ± Åifresini DeÄŸiÅŸtirmeã…¤ğŸ‰" ; tput sgr0
echo ""
echo -e "\033[1;33mKULLANICI LÄ°STESÄ° VE MEVCUT ÅÄ°FRELERÄ°: \033[0m"
echo ""

# Sistemdeki normal kullanÄ±cÄ±larÄ± (/etc/passwd dosyasÄ±ndan) listele.
_userT=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody)
i=0
unset _userPass

# Her bir kullanÄ±cÄ± iÃ§in bir dÃ¶ngÃ¼ baÅŸlat.
while read _user; do
    i=$(expr $i + 1)
    _oP=$i
    [[ $i == [1-9] ]] && i=0$i && oP+=" 0$i"
    
    # KullanÄ±cÄ±nÄ±n ÅŸifresini /etc/VPSManager/senha/ dizinindeki dosyadan okumayÄ± dene.
    if [[ -e "/etc/VPSManager/senha/$_user" ]]; then
        _senha="$(cat /etc/VPSManager/senha/$_user)"
    else
        # EÄŸer ÅŸifre dosyasÄ± yoksa 'Bilinmiyor' olarak belirt.
        _senha='Bilinmiyor'
    fi
    
    # KullanÄ±cÄ± adÄ±nÄ± ve ÅŸifresini formatlÄ± bir ÅŸekilde ekrana yazdÄ±r.
    suser=$(echo -e "\033[1;31m[\033[1;36m$i\033[1;31m] \033[1;37m- \033[1;32m$_user\033[0m")
    ssenha=$(echo -e "\033[1;33mÅifre\033[1;37m: $_senha")
    printf '%-60s%s\n' "$suser" "$ssenha"
    
    # Daha sonra kolay seÃ§im iÃ§in kullanÄ±cÄ± listesini bir deÄŸiÅŸkende biriktir.
    _userPass+="\n${_oP}:${_user}"
done <<< "${_userT}"

# Sistemdeki toplam kullanÄ±cÄ± sayÄ±sÄ±nÄ± bul.
num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
echo ""

# KullanÄ±cÄ±dan bir seÃ§im yapmasÄ±nÄ± iste.
echo -ne "\033[1;32mBir kullanÄ±cÄ± girin veya seÃ§in \033[1;33m[\033[1;36m1\033[1;31m-\033[1;36m$num_user\033[1;33m]\033[1;37m: " ; read option

# SeÃ§ilen numaraya karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ±nÄ± bul.
user=$(echo -e "${_userPass}" | grep -E "\b$option\b" | cut -d: -f2)

# EÄŸer giriÅŸ boÅŸ veya geÃ§ersizse hata ver.
if [[ -z $option ]]; then
    tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "BoÅŸ veya geÃ§ersiz alan!" ; echo "" ; tput sgr0
    exit 1
elif [[ -z $user ]]; then
    tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "BoÅŸ veya geÃ§ersiz bir isim girdiniz!" ; echo "" ; tput sgr0
    exit 1
else
    # SeÃ§ilen kullanÄ±cÄ± sistemde gerÃ§ekten var mÄ± diye kontrol et.
    if [[ `grep -c "/$user:" /etc/passwd` -ne 0 ]]; then
        # KullanÄ±cÄ±dan yeni ÅŸifreyi girmesini iste.
        echo -ne "\n\033[1;32m\033[1;33m$user\033[1;32m kullanÄ±cÄ±sÄ± iÃ§in yeni ÅŸifre\033[1;37m: "; read password
        
        # Åifrenin uzunluÄŸunu kontrol et.
        sizepass=$(echo ${#password})
        if [[ $sizepass -lt 4 ]]; then
            tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "BoÅŸ veya geÃ§ersiz ÅŸifre! En az 4 karakter kullanÄ±n." ; echo "" ; tput sgr0
            exit 1
        else
            # KullanÄ±cÄ±nÄ±n o anda sisteme baÄŸlÄ± olup olmadÄ±ÄŸÄ±nÄ± kontrol et.
            ps x | grep $user | grep -v grep | grep -v pt > /tmp/rem
            if [[ `grep -c $user /tmp/rem` -eq 0 ]]; then
                # EÄŸer kullanÄ±cÄ± baÄŸlÄ± deÄŸilse, ÅŸifresini direkt deÄŸiÅŸtir.
                echo "$user:$password" | chpasswd
                tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "$user kullanÄ±cÄ±sÄ±nÄ±n ÅŸifresi '$password' olarak deÄŸiÅŸtirildi." ; echo "" ; tput sgr0
                # Yeni ÅŸifreyi daha sonra gÃ¶stermek iÃ§in dosyaya kaydet.
                echo "$password" > /etc/VPSManager/senha/$user
                exit 1
            else
                # EÄŸer kullanÄ±cÄ± baÄŸlÄ±ysa, Ã¶nce baÄŸlantÄ±sÄ±nÄ± kes.
                echo ""
                tput setaf 7 ; tput setab 4 ; tput bold ; echo "KullanÄ±cÄ± Ã§evrimiÃ§i. BaÄŸlantÄ±sÄ± kesiliyor..." ; tput sgr0
                pkill -f $user
                
                # BaÄŸlantÄ±yÄ± kestikten sonra ÅŸifreyi deÄŸiÅŸtir.
                echo "$user:$password" | chpasswd
                tput setaf 7 ; tput setab 1 ; tput bold ; echo "" ; echo "$user kullanÄ±cÄ±sÄ±nÄ±n ÅŸifresi '$password' olarak deÄŸiÅŸtirildi." ; echo "" ; tput sgr0
                # Yeni ÅŸifreyi kaydet.
                echo "$password" > /etc/VPSManager/senha/$user
                exit 1
            fi
        fi
    else
        # EÄŸer kullanÄ±cÄ± sistemde bulunamazsa hata ver.
        tput setaf 7 ; tput setab 4 ; tput bold ; echo "" ; echo "$user kullanÄ±cÄ±sÄ± mevcut deÄŸil!" ; echo "" ; tput sgr0
    fi
fi