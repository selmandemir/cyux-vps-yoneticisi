#!/bin/bash

# Uzak sunucudan script'in versiyon bilgisini al.
_lvk=$(wget -qO- https://raw.githubusercontent.com/selmandemir/cyux-vps-yoneticisi/main/Sistema/versao)

# Sunucunun genel IP adresini iki farklı kaynaktan al ve karşılaştır.
IP=$(wget -qO- ipv4.icanhazip.com)
IP2=$(wget -qO- http://whatismyip.akamai.com/)
[[ "$IP" != "$IP2" ]] && ipdovps="$IP2" || ipdovps="$IP"
# Bulunan IP adresini /etc/IP dosyasına yaz.
echo -e "$ipdovps" >/etc/IP

# Script'e verilen komut satırı argümanlarını değişkenlere ata.
lst=$1 && lst1=$2 && lst2=$3 && key1=$4 && key2=crz

# Sunucunun saat dilimini Brezilya (Sao Paulo) olarak ayarla.
echo -e "America/Sao_Paulo" >/etc/timezone
ln -fs /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime >/dev/null 2>&1
dpkg-reconfigure --frontend noninteractive tzdata >/dev/null 2>&1

# Eğer ikinci argüman boşsa, temizlik yap ve çık.
[[ -z $lst1 ]] && {
    rm -rf $_Ink/list >/dev/null 2>&1 && cat /dev/null >~/.bash_history && history -c && exit 0
}

# Yönetim paneli için gerekli klasörlerin varlığını kontrol et, yoksa oluştur.
[[ ! -d /etc/VPSManager ]] && mkdir /etc/VPSManager
[[ ! -d /etc/VPSManager/senha ]] && mkdir /etc/VPSManager/senha
[[ ! -e /etc/VPSManager/Exp ]] && touch /etc/VPSManager/Exp
[[ ! -d /etc/VPSManager/userteste ]] && mkdir /etc/VPSManager/userteste
[[ ! -d /etc/VPSManager/.tmp ]] && mkdir /etc/VPSManager/.tmp
# Telegram Bot'u için gerekli klasörleri oluştur.
[[ ! -d /etc/bot ]] && mkdir /etc/bot
[[ ! -d /etc/bot/info-users ]] && mkdir /etc/bot/info-users
[[ ! -d /etc/bot/arquivos ]] && mkdir /etc/bot/arquivos
[[ ! -d /etc/bot/revenda ]] && mkdir /etc/bot/revenda
[[ ! -d /etc/bot/suspensos ]] && mkdir /etc/bot/suspensos
[[ ! -e /etc/bot/lista_ativos ]] && touch /etc/bot/lista_ativos
[[ ! -e /etc/bot/lista_suspensos ]] && touch /etc/bot/lista_suspensos

# Lisans ve bilgilendirme metinlerini oluştur.
echo -e 'by: @DRAGON_VPS_MANAGER' >/usr/lib/vpsmanager && cat /usr/lib/vpsmanager >$lst2/licence && cat /usr/lib/vpsmanager > /etc/VPSManager/.tmp/vps

# Apache web sunucusu 80 portunu kullanıyorsa, 8888 portuna taşı.
netstat -nplt | grep -w 'apache2' | grep -w '80' && sed -i "s/Listen 80/Listen 8888/g" /etc/apache2/ports.conf && service apache2 restart

# SSH ayarlarında Port 22'yi aktifleştir ve şifre ile girişe izin ver.
[[ "$(grep -o '#Port 22' /etc/ssh/sshd_config)" == "#Port 22" ]] && sed -i "s;#Port 22;Port 22;" /etc/ssh/sshd_config && service ssh restart
grep -v "^PasswordAuthentication" /etc/ssh/sshd_config >/tmp/passlogin && mv /tmp/passlogin /etc/ssh/sshd_config
echo "PasswordAuthentication yes" >>/etc/ssh/sshd_config

# Gerekli dosyaların indirileceği dizinleri tanımla.
_dir1='/bin'
_dir2='/etc/VPSManager'
_dir3='/root'
# Eski dosyaları temizle.
rm $_dir2/ShellBot.sh $_dir2/cabecalho $_dir2/open.py $_dir2/proxy.py $_dir2/wsproxy.py >/dev/null 2>&1

# İndirilecek tüm modüllerin (komutların) listesi.
_mdls=("addhost" "delhost" "alterarsenha" "criarusuario" "expcleaner" "mudardata" "remover" "criarteste" "verifbot" "droplimiter" "alterarlimite" "ajuda" "sshmonitor" "badvpn" "userbackup" "instsqd" "blockt" "otimizar" "menu" "speedtest" "banner" "senharoot" "reiniciarservicos" "reiniciarsistema" "attscript" "conexao" "delscript" "detalhes" "botssh"  "botteste" "botgen" "infousers" "verifatt" "limiter" "uexpired" "cabecalho" "bot" "botsshteste" "botgerador" "open.py" "slow_dns" "proxy.py" "wsproxy.py")
_mdls2=("onlineapp.sh")

# Döngü ile listedeki tüm modülleri indir, /bin klasörüne at ve çalıştırılabilir yap.
for _arq in ${_mdls[@]}; do
    [[ -e $_dir1/$_arq ]] && rm $_dir1/$_arq >/dev/null 2>&1
    wget -c -P $_dir1 https://raw.githubusercontent.com/selmandemir/cyux-vps-yoneticisi/main/Modulos/$_arq
    chmod +x $_dir1/$_arq
done
# Online kullanıcıları takip eden scripti indir ve çalıştırılabilir yap.
for _arq in ${_mdls2[@]}; do
    [[ -e $_dir3/$_arq ]] && rm $_dir3/$_arq >/dev/null 2>&1
    wget -c -P $_dir3 https://raw.githubusercontent.com/selmandemir/cyux-vps-yoneticisi/main/Modulos/$_arq
    chmod +x $_dir3/$_arq
done

# Gerekli bazı dosyaları doğru yerlerine taşı.
cd /var/www/html && mkdir server
cd /root && ./onlineapp.sh
mv $_dir1/cabecalho $_dir1/bot $_dir1/botsshteste $_dir1/botgerador $_dir1/open.py $_dir1/proxy.py $_dir1/wsproxy.py $_dir2

# Belirli alan adlarını /etc/hosts dosyasına ekleyerek yerel IP'ye yönlendir.
_arq_host="/etc/hosts"
_host[0]="d1n212ccp6ldpw.cloudfront.net"
_host[1]="dns.whatsapp.net"
_host[2]="portalrecarga.vivo.com.br/recarga"
_host[3]="navegue.vivo.com.br/controle/"
_host[4]="navegue.vivo.com.br/pre/"
_host[5]="www.whatsapp.net"
_host[6]="/VPSMANAGER?"
for host in ${_host[@]}; do
    if [[ "$(grep -w "$host" $_arq_host | wc -l)" = "0" ]]; then
        sed -i "3i\127.0.0.1 $host" $_arq_host
    fi
done

# Sistem başlangıcında çalışacak /etc/autostart scriptini oluştur veya temizle.
# Ayrıca çalışan bot scriptlerini ve screen oturumlarını temizler.
[[ ! -e /etc/autostart ]] && {
    echo '#!/bin/bash
clear
#AUTOMATIC START' >/etc/autostart
    chmod +x /etc/autostart
} || {
# ... (Bu bölüm birden çok kez tekrar ediyor, genel amacı çalışan botları durdurup autostart dosyasını sıfırlamak)
    [[ $(ps x | grep "bot_plus" | grep -v grep | wc -l) != '0' ]] && wget -qO- https://raw.githubusercontent.com/selmandemir/cyux-vps-yoneticisi/main/Install/ShellBot.sh
    for proc in $(ps x | grep 'dmS' | grep -v 'grep' | awk {'print $1'}); do
        screen -r -S "$proc" -X quit    
    done
    screen -wipe >/dev/null
    echo '#!/bin/bash
clear
#AUTOMATIC START' >/etc/autostart
    chmod +x /etc/autostart
}
# ... (Diğer botlar için tekrarlar)

# Mevcut tüm zamanlanmış görevleri (crontab) temizle.
crontab -r >/dev/null 2>&1
# Yeni zamanlanmış görevleri ekle.
(
    crontab -l 2>/dev/null
    echo "@daily /bin/verifatt" # Her gün güncelleme kontrolü yap
    echo "@reboot /etc/autostart" # Sistem açıldığında autostart scriptini çalıştır
    echo "* * * * * /etc/autostart" # Her dakika autostart scriptini çalıştır (kontrol amaçlı olabilir)
    echo "0 */6 * * * /bin/uexpired" # 6 saatte bir süresi dolan kullanıcıları kontrol et
    echo "*/1 * * * * cd /root/ && ./onlineapp.sh" # Her dakika online kullanıcıları kontrol et
) | crontab -

# Versiyon bilgisini dosyaya yaz.
echo "$_lvk" | sed -n '1 p' | cut -d' ' -f2 >/bin/versao && cat /bin/versao >/home/vpsmanager

# JSON işleyici olan 'jq' aracını indir ve kur.
wget https://github.com/selmandemir/cyux-vps-yoneticisi/raw/main/Install/jq-linux64 >/dev/null 2>&1
chmod +x jq-linux64 && mv jq-linux64 $(which jq)

# Değişikliklerin uygulanması için servisleri yeniden başlat.
service cron restart >/dev/null 2>&1
service ssh restart >/dev/null 2>&1
[[ -d /var/www/html/openvpn ]] && service apache2 restart >/dev/null 2>&1

# Kurulum sonrası geçici dosyaları temizle.
rm -rf $lst1/list >/dev/null 2>&1